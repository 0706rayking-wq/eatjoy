import React, { useState, useEffect, useCallback } from 'react';
import { 
  Bell, 
  BookOpen, 
  ShieldCheck, 
  Briefcase, 
  Wallet, 
  Camera, 
  Menu as MenuIcon, 
  Calendar, 
  ChevronRight, 
  ArrowLeft,
  CheckCircle2,
  Clock,
  MapPin,
  Car,
  Settings,
  Plus,
  Trash2,
  Lock,
  LogOut,
  X,
  User,
  CalendarDays,
  Stethoscope,
  Snowflake,
  Thermometer,
  Trash,
  Shirt,
  AlertCircle,
  Flame,
  HardHat,
  RefreshCcw,
  ClipboardCheck,
  Loader2,
  XCircle,
  Send,
  Image as ImageIcon,
  ChevronLeft,
  Bus,
  Bike,
  PlayCircle,
  Navigation as NavIcon
} from 'lucide-react';

const ZONES = [
  { id: 'beverage', name: 'é£²èª¿å€' },
  { id: 'light-meal', name: 'è¼•é£Ÿå€' },
  { id: 'seafood', name: 'æµ·é®®å€' },
  { id: 'vegetable', name: 'è”¬èœå€' },
  { id: 'meat', name: 'åˆ‡è‚‰å€' },
  { id: 'cold-platter', name: 'å†·ç›¤å€' },
  { id: 'cooked-food', name: 'ç†Ÿé£Ÿå€' },
  { id: 'soup', name: 'æ¹¯å“å€' },
];

const App = () => {
  const [currentPage, setCurrentPage] = useState('home');
  const [isManager, setIsManager] = useState(false);
  const [showLoginModal, setShowLoginModal] = useState(false);
  const [passwordInput, setPasswordInput] = useState('');
  const [loginError, setLoginError] = useState(false);
  const [selectedAnnouncement, setSelectedAnnouncement] = useState(null);
  const [selectedRuleCategory, setSelectedRuleCategory] = useState(null);

  // --- ç­è¡¨æ•¸æ“šå­˜å„² ---
  const [schedules, setSchedules] = useState(() => {
    const saved = localStorage.getItem('kitchen_schedules');
    return saved ? JSON.parse(saved) : {};
  });

  // --- ç‹€æ…‹è¿½è¹¤èˆ‡å®šæ™‚æ©Ÿåˆ¶ ---
  const [completedZones, setCompletedZones] = useState(() => {
    const saved = localStorage.getItem('kitchen_completed_zones');
    return saved ? JSON.parse(saved) : [];
  });
  const [lastResetDate, setLastResetDate] = useState(localStorage.getItem('kitchen_last_reset') || "");
  const [notificationLog, setNotificationLog] = useState([]); 

  // --- AI å·¡è¦–ç³»çµ±æ•¸æ“šå­˜å„² ---
  const [standards, setStandards] = useState(() => {
    const saved = localStorage.getItem('kitchen_standards');
    return saved ? JSON.parse(saved) : {};
  });

  const [announcements, setAnnouncements] = useState([
    { id: 1, date: '2024-05-20', title: 'å¤å­£èœå–®èª¿æ•´é€šçŸ¥', content: 'å¾ä¸‹é€±ä¸€èµ·ï¼Œç†Ÿé£Ÿå€å°‡æ–°å¢ä¸‰é“å¤å­£æ¶¼æ‹Œèœï¼Œè«‹å„å€äººå“¡ç•™æ„å‡ºé¤æ¨™æº–ã€‚åŒ…å«æ¶¼æ‹Œé’æœ¨ç“œã€èƒ¡éº»é»ƒç“œä»¥åŠæ³°å¼é…¸è¾£èŠ±æï¼Œå‚™æ–™æ™‚è«‹æ³¨æ„æ–°é®®åº¦èˆ‡åˆ†é‡æ§åˆ¶ã€‚', author: 'ä¸»å»š é˜¿æ˜' },
    { id: 2, date: '2024-05-18', title: 'è¨­å‚™ç¶­è­·å…¬å‘Š', content: 'é€±ä¸‰å‡Œæ™¨å°‡é€²è¡ŒæŠ½æ²¹ç…™æ©Ÿæ·±åº¦æ¸…æ½”ï¼Œè«‹æ™šç­äººå“¡é…åˆæ”¶å ´ã€‚æ‰€æœ‰æ¿¾ç¶²éœ€æ‹†å¸ä¸¦æ”¾ç½®æ–¼æ´—æ»Œç±ƒä¸­ï¼Œç¢ºä¿ç®¡è·¯å…§éƒ¨å®Œå…¨æ·¨ç©ºä»¥åˆ©å» å•†ä½œæ¥­ã€‚', author: 'åº—é•· å°è¯' }
  ]);

  useEffect(() => {
    localStorage.setItem('kitchen_schedules', JSON.stringify(schedules));
  }, [schedules]);

  useEffect(() => {
    localStorage.setItem('kitchen_standards', JSON.stringify(standards));
  }, [standards]);

  useEffect(() => {
    localStorage.setItem('kitchen_completed_zones', JSON.stringify(completedZones));
  }, [completedZones]);

  const sendLineNotification = useCallback((message) => {
    const time = new Date().toLocaleTimeString();
    setNotificationLog(prev => [{ time, message }, ...prev].slice(0, 5));
  }, []);

  useEffect(() => {
    const timer = setInterval(() => {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const todayStr = now.toDateString();

      if (hours === 19 && minutes === 0 && lastResetDate !== todayStr) {
        setCompletedZones([]);
        setLastResetDate(todayStr);
        localStorage.setItem('kitchen_last_reset', todayStr);
        sendLineNotification("ğŸ® ç³»çµ±å·²é‡ç½®ï¼Œæº–å‚™é–‹å§‹ä»Šæ—¥æ™šç­å–„å¾Œå·¡è¦–ã€‚");
      }

      if (hours === 22 && minutes === 30 && lastResetDate === todayStr) {
        if (completedZones.length < ZONES.length) {
          const remaining = ZONES.filter(z => !completedZones.includes(z.id)).map(z => z.name);
          sendLineNotification(`âš ï¸ æé†’ï¼šç›®å‰å°šæœ‰å€ç«™æœªä¸Šå‚³å®Œæˆï¼\næœªå®Œæˆå€åŸŸï¼š${remaining.join(', ')}`);
        }
      }
    }, 1000 * 30);
    return () => clearInterval(timer);
  }, [completedZones, lastResetDate, sendLineNotification]);

  useEffect(() => {
    if (completedZones.length === ZONES.length && ZONES.length > 0) {
      sendLineNotification("âœ… ä»Šæ—¥å…¨æ•¸å€ç«™å·²ä¸Šå‚³å®Œç•¢ï¼è«‹ä¸»ç®¡é€²è¡Œæœ€å¾Œäººå·¥æª¢æŸ¥ã€‚");
    }
  }, [completedZones, sendLineNotification]);

  const handleLogin = () => {
    if (passwordInput === 'eatjoy0706') {
      setIsManager(true);
      setShowLoginModal(false);
      setPasswordInput('');
      setLoginError(false);
    } else {
      setLoginError(true);
    }
  };

  const handleLogout = () => {
    setIsManager(false);
    setCurrentPage('home');
  };

  // --- è¦å‰‡è³‡æ–™ ---
  const hygieneRules = [
    { category: "é«”æª¢", rules: ["å¾æ¥­äººå“¡å¥åº·æª¢æŸ¥æ‡‰åŒ…æ‹¬èƒ¸éƒ¨Xå…‰åŠAå‹è‚ç‚æŠ—é«”æª¢é©—ã€‚"] },
    { category: "é£Ÿæé›¢åœ°", rules: ["é£Ÿææ‡‰é›¢ç‰†5å…¬åˆ†ï¼Œé›¢åœ°20å…¬åˆ†ã€‚"] },
    { category: "å…ˆé€²å…ˆå‡º", rules: ["å†°ç®±é£Ÿæå®œæ‰“æ¨™ã€å¡«å¯«æ—¥æœŸã€å§“åã€‚"] },
    { category: "åŠ å°åŠ è“‹", rules: ["éµç½é–‹å°å¾Œéœ€ç”¨å…¶ä»–å®¹å™¨åˆ†è£ï¼Œé¿å…ç”Ÿé½ã€‚"] }
  ];
  const occupationalSafetyRules = [
    { category: "è¨­å‚™æ“ä½œå®‰å…¨", rules: ["åˆ‡è‚‰æ©Ÿã€åˆ‡è”¥æ©Ÿåš´ç¦å¾’æ‰‹æ¥è§¸åˆ€ç‰‡ã€‚", "å‡è³ªæ©Ÿå…ˆé‡‹å£“å†é–‹è“‹ã€‚", "ç“¦æ–¯çˆé †åºï¼šç“¦æ–¯â†’é»ç«â†’é—œç«â†’é—œç“¦æ–¯ã€‚"] }
  ];
  const kitchenStandardRules = [
    { id: 1, text: "ä¾è¦å®šè«‹å‡,ä¸Šç­é²åˆ°ã€ç¿¹ç­,ä¾æŒ‡ç¤ºåˆ·ä¸‹ç­å¡", sub: "æ–¼æ™‚é–“å…§ä¸Šå´—,å¦å‰‡è¦–åŒé²åˆ°" },
    { id: 3, text: "ç¦æ­¢éå¹¹éƒ¨ä¸Šç­æ™‚é–“ä¸å¯ä½¿ç”¨æ‰‹æ©Ÿ", sub: "ç™¼ç¾ä¸€ç‡æ‡²è™•" },
    { id: 10, text: "æœè£å„€å®¹è¦å®š,å¦‚å»æ™‚é–“å…­åˆ†é˜", sub: "é ­é«®ä¸å¤–éœ²,ç©¿å®‰å…¨é‹" }
  ];

  const renderContent = () => {
    switch (currentPage) {
      case 'home':
        return <HomePage onNavigate={setCurrentPage} announcements={announcements} isManager={isManager} completedCount={completedZones.length} onOpenDetail={(ann) => { setSelectedAnnouncement(ann); setCurrentPage('announcementDetail'); }} />;
      case 'onboarding':
        return <OnboardingPage onBack={() => setCurrentPage('home')} onNavigate={setCurrentPage} />;
      case 'workRouteDetail':
        return <WorkRoutePage onBack={() => setCurrentPage('onboarding')} />;
      case 'rules':
        return <RulesPage onBack={() => setCurrentPage('home')} onSelectCategory={(cat) => { setSelectedRuleCategory(cat); setCurrentPage('ruleDetail'); }} />;
      case 'ruleDetail':
        return <RuleDetailPage category={selectedRuleCategory} hygieneRules={hygieneRules} standardRules={kitchenStandardRules} occupationalSafetyRules={occupationalSafetyRules} onBack={() => setCurrentPage('rules')} />;
      case 'inspection':
        return <InspectionModule onBack={() => setCurrentPage('home')} standards={standards} setStandards={setStandards} completedZones={completedZones} setCompletedZones={setCompletedZones} isManager={isManager} />;
      case 'benefits': return <BenefitsPage onBack={() => setCurrentPage('home')} />;
      case 'menu': return <MenuPage onBack={() => setCurrentPage('home')} />;
      case 'schedule': return <SchedulePage onBack={() => setCurrentPage('home')} schedules={schedules} />;
      case 'admin':
        return <AdminPage 
          onBack={() => setCurrentPage('home')} 
          announcements={announcements} 
          onAdd={(t, c) => setAnnouncements([{id: Date.now(), date: new Date().toISOString().split('T')[0], title: t, content: c, author: 'ç®¡ç†å“¡'}, ...announcements])} 
          onDelete={(id) => setAnnouncements(announcements.filter(a => a.id !== id))} 
          onLogout={handleLogout} 
          notificationLog={notificationLog} 
          schedules={schedules}
          setSchedules={setSchedules}
        />;
      case 'announcementDetail':
        return <AnnouncementDetailPage ann={selectedAnnouncement} onBack={() => setCurrentPage('home')} />;
      default:
        return <HomePage onNavigate={setCurrentPage} announcements={announcements} isManager={isManager} completedCount={completedZones.length} onOpenDetail={(ann) => { setSelectedAnnouncement(ann); setCurrentPage('announcementDetail'); }} />;
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-900 pb-10">
      <div className={`${isManager ? 'bg-slate-800' : 'bg-orange-600'} text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-md transition-colors duration-300`}>
        <h1 className="font-bold text-xl tracking-tight cursor-pointer flex items-center gap-2" onClick={() => setCurrentPage('home')}>
          <div className="bg-white/20 p-1 rounded-lg"><ChefHatIcon /></div>
          Kitchen OS
        </h1>
        <div className="flex gap-4">
          <Bell size={20} className="cursor-pointer" onClick={() => isManager && setCurrentPage('admin')} />
          <button onClick={() => isManager ? setCurrentPage('admin') : setShowLoginModal(true)}>
            {isManager ? <Settings size={20} /> : <MenuIcon size={20} />}
          </button>
        </div>
      </div>

      <main className="max-w-md mx-auto p-4">
        {renderContent()}
      </main>

      {showLoginModal && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-6">
          <div className="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl animate-in zoom-in duration-200 text-center">
            <div className="bg-orange-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-600"><Lock size={30} /></div>
            <h2 className="text-2xl font-black mb-2">ä¸»ç®¡æˆæ¬Š</h2>
            <div className="space-y-4 mt-6">
              <input 
                type="password" 
                value={passwordInput}
                onChange={(e) => setPasswordInput(e.target.value)}
                placeholder="Password"
                className={`w-full bg-slate-100 border-2 ${loginError ? 'border-red-400' : 'border-transparent'} focus:border-orange-500 rounded-2xl px-5 py-4 outline-none transition-all font-black text-center tracking-widest`}
                onKeyDown={(e) => e.key === 'Enter' && handleLogin()}
              />
              <button onClick={handleLogin} className="w-full bg-slate-900 text-white font-black py-4 rounded-2xl shadow-xl active:scale-95 transition-transform uppercase">Login</button>
              <button onClick={() => setShowLoginModal(false)} className="text-slate-400 text-xs font-bold uppercase tracking-widest">å–æ¶ˆ</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// --- çµ„ä»¶ï¼šé¦–é  ---
const HomePage = ({ onNavigate, announcements, isManager, completedCount, onOpenDetail }) => (
  <div className="space-y-6 animate-in fade-in duration-500">
    <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 flex items-center justify-between">
      <div className="flex items-center gap-4">
        <div className="w-12 h-12 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center font-black">{completedCount}</div>
        <div><p className="text-[10px] font-black text-slate-300 uppercase tracking-widest">å–„å¾Œé€²åº¦</p><p className="text-sm font-black text-slate-700">{completedCount === ZONES.length ? "âœ… å…¨æ•¸å®Œæˆ" : `å°šæœ‰ ${ZONES.length - completedCount} ç«™å¾…è™•ç†`}</p></div>
      </div>
      <button onClick={() => onNavigate('inspection')} className="p-3 bg-orange-600 text-white rounded-2xl active:scale-90 transition-transform"><Camera size={20}/></button>
    </div>
    <section>
      <div className="flex items-center justify-between mb-3 px-1"><h2 className="text-lg font-bold flex items-center gap-2"><Bell className="text-orange-500" size={18} /> ç‡Ÿé‹èª¿æ•´å…¬å‘Š</h2></div>
      <div className="space-y-3">
        {announcements.map(ann => (
          <div key={ann.id} onClick={() => onOpenDetail(ann)} className="bg-white p-5 rounded-[2rem] shadow-sm border-l-4 border-orange-500 active:bg-orange-50 transition-colors cursor-pointer group">
            <div className="flex justify-between items-start mb-1">
              <h3 className="font-bold text-slate-800 text-sm group-hover:text-orange-600 transition-colors">{ann.title}</h3>
              <span className="text-[9px] text-slate-400 bg-slate-50 px-2 py-1 rounded-full font-bold">{ann.date}</span>
            </div>
            <p className="text-xs text-slate-500 line-clamp-2 break-all leading-relaxed">{ann.content}</p>
          </div>
        ))}
      </div>
    </section>
    <section className="grid grid-cols-2 gap-4">
      <NavCard title="å…¥è·ç›¸é—œ" onClick={() => onNavigate('onboarding')} color="bg-blue-50/50" />
      <NavCard title="å“¡å·¥å®ˆå‰‡" onClick={() => onNavigate('rules')} color="bg-emerald-50/50" />
      <NavCard title="è–ªè³‡ç¦åˆ©" onClick={() => onNavigate('benefits')} color="bg-yellow-50/50" />
      <NavCard title="å„å­£èœå–®" onClick={() => onNavigate('menu')} color="bg-emerald-50/30" />
      <NavCard title="æ¯æœˆç­è¡¨" onClick={() => onNavigate('schedule')} color="bg-indigo-50/50" />
      <NavCard title="å–„å¾Œå·¡è¦–" onClick={() => onNavigate('inspection')} color="bg-orange-50" span={true} />
    </section>
  </div>
);

// --- çµ„ä»¶ï¼šä¸Šç­å‹•ç·šè©³æƒ… ---
const WorkRoutePage = ({ onBack }) => (
  <div className="animate-in slide-in-from-right duration-300 space-y-6">
    <BackButton onClick={onBack} title="ä¸Šç­å‹•ç·šæŒ‡å¼•" />
    <section className="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
      <div className="flex items-center gap-3 mb-4">
        <div className="bg-blue-100 p-2 rounded-xl text-blue-600"><Bus size={20} /></div>
        <h3 className="text-lg font-black text-slate-700">æ­ä¹˜å¤§çœ¾é‹è¼¸è·¯ç·š</h3>
      </div>
      <div className="aspect-video bg-slate-100 rounded-2xl flex flex-col items-center justify-center border-2 border-dashed border-slate-200">
        <PlayCircle size={40} className="text-slate-300 mb-2" />
        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">å½±ç‰‡é ç•™ç©ºé–“</p>
      </div>
    </section>
    <section className="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
      <div className="flex items-center gap-3 mb-4">
        <div className="bg-orange-100 p-2 rounded-xl text-orange-600"><Bike size={20} /></div>
        <h3 className="text-lg font-black text-slate-700">é–‹è»Šæˆ–é¨è»Šè·¯ç·š</h3>
      </div>
      <div className="aspect-video bg-slate-100 rounded-2xl flex flex-col items-center justify-center border-2 border-dashed border-slate-200">
        <PlayCircle size={40} className="text-slate-300 mb-2" />
        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">å½±ç‰‡é ç•™ç©ºé–“</p>
      </div>
    </section>
  </div>
);

// --- çµ„ä»¶ï¼šæ¯æœˆç­è¡¨å±•ç¤º ---
const SchedulePage = ({ onBack, schedules }) => {
  const now = new Date();
  const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  const [viewMonth, setViewMonth] = useState(currentMonthKey);
  const currentSchedules = schedules[viewMonth] || [];
  return (
    <div className="animate-in slide-in-from-right duration-300">
      <BackButton onClick={onBack} title="æ¯æœˆç­è¡¨æŸ¥è©¢" />
      <div className="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 mb-6 flex items-center justify-between">
        <input type="month" value={viewMonth} onChange={(e) => setViewMonth(e.target.value)} className="bg-slate-50 px-4 py-2 rounded-xl font-bold text-slate-700 outline-none" />
      </div>
      <div className="space-y-4">
        {currentSchedules.length > 0 ? (
          currentSchedules.map((img, i) => (<div key={i} className="bg-white p-2 rounded-3xl shadow-md border border-slate-100"><img src={img} className="w-full rounded-2xl shadow-inner" alt="Schedule" /></div>))
        ) : (
          <div className="bg-white p-12 rounded-[2.5rem] border-2 border-dashed border-slate-100 text-center py-12 text-slate-400 font-bold">è©²æœˆä»½å°šæœªä¸Šå‚³ç­è¡¨</div>
        )}
      </div>
    </div>
  );
};

// --- çµ„ä»¶ï¼šä¸»ç®¡ç®¡ç†å¾Œå° ---
const AdminPage = ({ onBack, announcements, onAdd, onDelete, onLogout, notificationLog, schedules, setSchedules }) => {
  const [t, setT] = useState(''); const [c, setC] = useState('');
  const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
  const handleScheduleUpload = (e) => {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onloadend = () => setSchedules(prev => ({...prev, [selectedMonth]: [...(prev[selectedMonth] || []), reader.result]}));
      reader.readAsDataURL(file);
    });
  };
  return (
    <div className="space-y-6 animate-in slide-in-from-right duration-300">
      <div className="flex justify-between items-center"><BackButton onClick={onBack} title="ä¸»ç®¡æ§åˆ¶ä¸­å¿ƒ" /><button onClick={onLogout} className="bg-red-50 text-red-500 font-black text-[10px] px-4 py-2 rounded-full uppercase">Logout</button></div>
      
      <section className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
        <h3 className="font-black text-xs text-blue-500 uppercase tracking-widest mb-4 flex items-center gap-2"><Calendar size={14}/> ç­è¡¨ç®¡ç†</h3>
        <div className="flex gap-2 mb-4"><input type="month" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="flex-1 bg-slate-50 p-3 rounded-xl font-bold text-sm outline-none" /><label className="bg-blue-600 text-white px-4 py-3 rounded-xl text-xs font-black cursor-pointer active:scale-95 flex items-center gap-2"><Plus size={14} /> ä¸Šå‚³<input type="file" accept="image/*" multiple className="hidden" onChange={handleScheduleUpload} /></label></div>
        <div className="grid grid-cols-4 gap-2">{schedules[selectedMonth]?.map((img, i) => (<div key={i} className="relative aspect-square group"><img src={img} className="w-full h-full object-cover rounded-xl border border-slate-100" alt="Admin Schedule" /><button onClick={() => setSchedules(prev => ({...prev, [selectedMonth]: prev[selectedMonth].filter((_, idx) => idx !== i)}))} className="absolute -top-1 -right-1 bg-red-500 text-white p-1 rounded-full shadow-md"><Trash2 size={10}/></button></div>))}</div>
      </section>

      <section className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
        <h3 className="font-black text-xs text-orange-400 uppercase tracking-widest mb-4">ç™¼å¸ƒæ–°å…¬å‘Š</h3>
        <input placeholder="æ¨™é¡Œ" value={t} onChange={e => setT(e.target.value)} className="w-full bg-slate-50 p-4 rounded-2xl mb-3 outline-none focus:ring-2 focus:ring-orange-500 font-bold text-sm" />
        <textarea placeholder="å…§å®¹" rows="3" value={c} onChange={e => setC(e.target.value)} className="w-full bg-slate-50 p-4 rounded-2xl mb-4 outline-none focus:ring-2 focus:ring-orange-500 text-sm" />
        <button onClick={() => { if(t&&c){ onAdd(t,c); setT(''); setC(''); } }} className="w-full bg-slate-900 text-white font-black py-4 rounded-2xl">ç™¼å¸ƒ</button>
      </section>

      <section className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
        <h3 className="font-black text-xs text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"><Send size={14}/> é€šçŸ¥æ—¥èªŒ</h3>
        <div className="space-y-2">{notificationLog.map((log, i) => (<div key={i} className="text-[10px] bg-slate-50 p-2 rounded-lg border border-slate-100"><span className="text-slate-400 font-bold mr-2">[{log.time}]</span> <span className="text-slate-600">{log.message}</span></div>))}</div>
      </section>
      
      <div className="space-y-2">{announcements.map(a => <div key={a.id} className="bg-white p-4 rounded-2xl flex justify-between items-center border border-slate-50"><span className="font-bold text-xs text-slate-700 truncate mr-4">{a.title}</span><button onClick={() => onDelete(a.id)} className="text-slate-200 hover:text-red-500 transition-colors"><Trash2 size={16} /></button></div>)}</div>
    </div>
  );
};

// --- çµ„ä»¶ï¼šAI å–„å¾Œå·¡è¦–æ¨¡çµ„ ---
const InspectionModule = ({ onBack, standards, setStandards, completedZones, setCompletedZones, isManager }) => {
  const [view, setView] = useState('dashboard'); const [activeZone, setActiveZone] = useState(null); const [currentUploads, setCurrentUploads] = useState([]); const [inspectionResult, setInspectionResult] = useState(null); const [loading, setLoading] = useState(false);
  const handleFileUpload = (e, target, zoneId = null) => {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onloadend = () => { if (target === 'standard') { setStandards(prev => ({ ...prev, [zoneId]: [...(prev[zoneId] || []), reader.result] })); } else { setCurrentUploads(prev => [...prev, reader.result]); } };
      reader.readAsDataURL(file);
    });
  };
  const runAIInspection = async () => {
    setLoading(true);
    setTimeout(() => {
      const result = { status: "PASS", score: 95, summary: "æ¸…æ½”åˆæ ¼ã€‚", feedback: ["éå¸¸æ£’"] };
      setInspectionResult(result);
      if (result.status === "PASS" && !completedZones.includes(activeZone.id)) setCompletedZones(prev => [...prev, activeZone.id]);
      setLoading(false);
    }, 2000);
  };
  return (
    <div className="animate-in fade-in duration-300">
      <div className="flex justify-between items-center mb-6"><button onClick={() => view === 'dashboard' ? onBack() : setView('dashboard')} className="p-3 bg-white rounded-2xl shadow-sm border border-slate-100"><ArrowLeft size={20}/></button><h2 className="text-xl font-black text-slate-800 flex items-center gap-2"><ClipboardCheck size={20} className="text-orange-600"/> å–„å¾Œå·¡è¦–</h2>{isManager && <button onClick={() => setView('settings')} className="p-3 bg-white rounded-2xl shadow-sm border border-slate-100 text-slate-400"><Settings size={20}/></button>}</div>
      {view === 'dashboard' && (
        <div className="space-y-4">
          <div className="bg-gradient-to-r from-orange-500 to-orange-400 p-6 rounded-[2.5rem] text-white shadow-lg flex justify-between items-center"><div><p className="text-[10px] font-black uppercase opacity-70 mb-1">Overall Progress</p><p className="text-2xl font-black">{completedZones.length} / {ZONES.length}</p></div><div className="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center border border-white/30 font-black">{Math.round((completedZones.length/ZONES.length)*100)}%</div></div>
          <div className="grid grid-cols-1 gap-2">
            {ZONES.map(zone => {
              const isDone = completedZones.includes(zone.id);
              return (<button key={zone.id} onClick={() => { setActiveZone(zone); setView('inspection'); setCurrentUploads([]); setInspectionResult(null); }} className={`bg-white px-6 py-6 rounded-3xl shadow-sm flex justify-between items-center border transition-all ${isDone ? 'border-emerald-100 bg-emerald-50/20' : 'border-slate-100'}`}><div className="flex items-center gap-3"><div className={`p-2 rounded-xl ${isDone ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-300'}`}>{isDone ? <CheckCircle2 size={18}/> : <Camera size={18}/>}</div><span className={`font-black ${isDone ? 'text-emerald-700' : 'text-slate-600'}`}>{zone.name}</span></div>{isDone ? <span className="text-[10px] font-black text-emerald-500 uppercase tracking-tighter">Done</span> : <ChevronRight size={18} className="text-slate-200" />}</button>);
            })}
          </div>
        </div>
      )}
      {view === 'inspection' && activeZone && (
        <div className="space-y-6">
          <h3 className="text-4xl font-black text-slate-800 text-center tracking-tighter">{activeZone.name}</h3>
          <section><p className="text-xs font-black text-slate-300 uppercase mb-3 text-center tracking-widest">Standard Ref</p><div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">{standards[activeZone.id]?.map((img, i) => <img key={i} src={img} className="w-32 h-32 object-cover rounded-3xl border-2 border-white shadow-sm" alt="Reference" />)}</div></section>
          <section className="bg-white p-8 rounded-[3rem] shadow-sm border border-slate-100 text-center">
            <div className="grid grid-cols-3 gap-3 mb-8">{currentUploads.map((img, i) => (<div key={i} className="relative aspect-square"><img src={img} className="w-full h-full object-cover rounded-2xl" alt="Actual" /><button onClick={() => setCurrentUploads(prev => prev.filter((_, idx) => idx !== i))} className="absolute -top-2 -right-2 bg-red-500 text-white p-1.5 rounded-full shadow-lg"><Trash2 size={10}/></button></div>))}<label className="aspect-square bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center cursor-pointer active:scale-95 transition-all"><Plus className="text-slate-300"/><input type="file" accept="image/*" multiple className="hidden" onchange={(e) => handleFileUpload(e, 'actual')} /></label></div>
            <button onClick={runAIInspection} disabled={loading || currentUploads.length === 0} className={`w-full py-5 rounded-[2rem] font-black text-lg shadow-xl flex items-center justify-center gap-2 ${loading || currentUploads.length === 0 ? 'bg-slate-100 text-slate-300' : 'bg-orange-600 text-white'}`}>{loading ? <Loader2 className="animate-spin" /> : <><Send size={18}/> å•Ÿå‹• AI åˆ¤å®š</>}</button>
          </section>
        </div>
      )}
      {view === 'settings' && (<div className="space-y-6"><h2 className="text-3xl font-black text-slate-800 px-2 tracking-tighter">å€åŸŸæ¨™æº–ç…§ç®¡ç†</h2>{ZONES.map(zone => (<div key={zone.id} className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100"><div className="flex justify-between items-center mb-4"><h3 className="text-lg font-black text-slate-700">{zone.name}</h3><label className="bg-slate-900 text-white px-5 py-2.5 rounded-2xl text-xs font-black uppercase cursor-pointer">Upload<input type="file" accept="image/*" multiple className="hidden" onChange={(e) => handleFileUpload(e, 'standard', zone.id)} /></label></div><div className="grid grid-cols-4 gap-2">{standards[zone.id]?.map((img, i) => (<div key={i} className="relative aspect-square group"><img src={img} className="w-full h-full object-cover rounded-xl" alt="Standard Management" /><button onClick={() => setStandards(prev => ({...prev, [zone.id]: prev[zone.id].filter((_, idx) => idx !== i)}))} className="absolute -top-1 -right-1 bg-red-500 text-white p-1 rounded-full shadow-md"><Trash2 size={10}/></button></div>))}</div></div>))}</div>)}
    </div>
  );
};

// --- è¼”åŠ©å°çµ„ä»¶ ---
const ChefHatIcon = () => <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" strokeWidth="2.5" fill="none" strokeLinecap="round" strokeLinejoin="round"><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/><line x1="6" y1="17" x2="18" y2="17"/></svg>;
const NavCard = ({ title, onClick, color, span = false }) => (
  <button onClick={onClick} className={`${color} ${span ? 'py-16' : 'py-12'} flex flex-col items-center justify-center rounded-[2.5rem] shadow-sm border border-slate-100 active:scale-95 transition-all`}><span className="font-black text-slate-800 text-xl tracking-tighter uppercase">{title}</span></button>
);
const BackButton = ({ onClick, title }) => (
  <div className="flex items-center gap-4 mb-8"><button onClick={onClick} className="p-3 bg-white rounded-2xl shadow-sm border border-slate-100 active:scale-90 transition-transform"><ArrowLeft size={20}/></button><h2 className="text-2xl font-black text-slate-800 tracking-tighter">{title}</h2></div>
);

const IconWrapper = ({ iconName }) => {
  const icons = { 
    BookOpen, 
    Car, 
    Navigation: NavIcon,
    ShieldCheck, 
    Flame, 
    Briefcase 
  };
  const Icon = icons[iconName];
  return Icon ? <Icon size={18} /> : null;
};

const SectionItem = ({ icon, title, onClick }) => (
  <div onClick={onClick} className="bg-white p-6 rounded-[2rem] flex items-center justify-between shadow-sm border border-slate-100 active:bg-slate-50 cursor-pointer">
    <div className="flex items-center gap-4">
      <div className="text-slate-400">
        {icon && <IconWrapper iconName={icon} />}
      </div>
      <span className="font-bold text-slate-700 text-sm">{title}</span>
    </div>
    <ChevronRight size={18} className="text-slate-200" />
  </div>
);

const RulesPage = ({ onBack, onSelectCategory }) => <div className="space-y-4 animate-in slide-in-from-right duration-300"><BackButton onClick={onBack} title="å“¡å·¥å®ˆå‰‡" /><div className="space-y-3"><button onClick={() => onSelectCategory("é£Ÿå“è¡›ç”Ÿå®‰å…¨è¦ç¯„")} className="w-full text-left"><SectionItem icon="ShieldCheck" title="é£Ÿå“è¡›ç”Ÿå®‰å…¨è¦ç¯„" /></button><button onClick={() => onSelectCategory("è·å ´è·æ¥­å®‰å…¨å®ˆå‰‡")} className="w-full text-left"><SectionItem icon="Flame" title="è·å ´è·æ¥­å®‰å…¨å®ˆå‰‡" /></button><button onClick={() => onSelectCategory("å»šæˆ¿æ¨™æº–å·¥ä½œå®ˆå‰‡")} className="w-full text-left"><SectionItem icon="BookOpen" title="å»šæˆ¿æ¨™æº–å·¥ä½œå®ˆå‰‡" /></button></div></div>;
const RuleDetailPage = ({ category, hygieneRules, standardRules, occupationalSafetyRules, onBack }) => {
  const isH = category === "é£Ÿå“è¡›ç”Ÿå®‰å…¨è¦ç¯„"; const isS = category === "å»šæˆ¿æ¨™æº–å·¥ä½œå®ˆå‰‡"; const isO = category === "è·å ´è·æ¥­å®‰å…¨å®ˆå‰‡";
  return (
    <div className="animate-in slide-in-from-right duration-300 pb-10"><BackButton onClick={onBack} title={category} />
      {isH && hygieneRules.map((item, i) => <div key={i} className="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 mb-4"><h3 className="font-bold text-emerald-600 mb-3 text-sm flex gap-2"><span>{i+1}.</span> {item.category}</h3><ul className="space-y-2">{item.rules.map((r, idx) => <li key={idx} className="text-xs text-slate-500 leading-relaxed break-all">â€¢ {r}</li>)}</ul></div>)}
      {isS && standardRules.map((item) => <div key={item.id} className="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 mb-4"><div className="flex gap-4"><span className="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-[10px] font-black shrink-0">{item.id}</span><div className="space-y-2"><h3 className="font-bold text-slate-800 text-xs">{item.text}</h3><p className="text-[10px] text-slate-400 italic bg-slate-50 p-3 rounded-xl">{item.sub}</p></div></div></div>)}
      {isO && occupationalSafetyRules.map((section, i) => <div key={i} className="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 mb-4"><h3 className="font-bold text-orange-600 mb-3 text-sm">{section.category}</h3><ul className="space-y-2">{section.rules.map((r, idx) => <li key={idx} className="text-xs text-slate-500 leading-relaxed">â€¢ {r}</li>)}</ul></div>)}
    </div>
  );
};
const OnboardingPage = ({ onBack, onNavigate }) => (
  <div className="animate-in slide-in-from-right duration-300">
    <BackButton onClick={onBack} title="å…¥è·ç›¸é—œ" />
    <div className="space-y-3">
      <SectionItem icon="BookOpen" title="å“¡å·¥å…¥è·æº–å‚™æ¸…å–®" />
      <SectionItem icon="Car" title="åœè»Šè³‡è¨Š" />
      <SectionItem icon="Navigation" title="ä¸Šç­å‹•ç·š" onClick={() => onNavigate('workRouteDetail')} />
    </div>
  </div>
);
const BenefitsPage = ({ onBack }) => <div className="animate-in slide-in-from-right duration-300"><BackButton onClick={onBack} title="è–ªè³‡ç¦åˆ©" /><div className="bg-gradient-to-br from-yellow-400 to-orange-500 p-8 rounded-[2.5rem] text-white shadow-lg mb-6"><p className="text-[10px] font-black uppercase opacity-80">è–ªè³‡èˆ‡çé‡‘</p><p className="text-3xl font-black">$ 32,800 +</p></div><SectionItem title="è€ƒæ ¸åŠ çµ¦æ¨™æº–" /><SectionItem title="å“¡å·¥ç›¸é—œç¦åˆ©" /></div>;
const MenuPage = ({ onBack }) => <div className="animate-in slide-in-from-right duration-300"><BackButton onClick={onBack} title="å„å­£èœå–®" /><div className="grid grid-cols-2 gap-4">{["ç†Ÿé£Ÿ", "ç”œé»", "é™é‡", "å£½æ˜Ÿ"].map(m => <div key={m} className="aspect-square bg-white rounded-3xl flex items-center justify-center font-bold text-slate-300 text-sm border border-slate-100">{m}</div>)}</div></div>;
const AnnouncementDetailPage = ({ ann, onBack }) => <div className="animate-in slide-in-from-right duration-300"><BackButton onClick={onBack} title="å…¬å‘Šè©³æƒ…" /><div className="bg-white rounded-[2rem] p-8 shadow-sm border border-slate-100"><h1 className="text-2xl font-black text-slate-800 mb-2">{ann?.title}</h1><p className="text-[10px] text-slate-400 font-bold mb-6">{ann?.date} â€¢ {ann?.author}</p><div className="text-sm text-slate-600 leading-relaxed break-all whitespace-pre-wrap">{ann?.content}</div></div></div>;

export default App;
