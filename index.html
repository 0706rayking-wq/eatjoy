<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen OS - 企業版</title>
    <!-- 引入核心庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK (相容模式 v8) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        :root { 
            --brand-orange: #f97316; 
            --bg-light: #fff5f5; /* 淡紅色背景 */
        }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: var(--bg-light); 
            color: #1e293b; 
            overflow-x: hidden; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .page-enter { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .toast-enter { animation: slideDown 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes slideDown { from { opacity: 0; transform: translate(-50%, -100%); } to { opacity: 1; transform: translate(-50%, 0); } }
        .glass-panel { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.5); 
            box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.04); 
        }
        .input-light { background: #ffffff; border: 1px solid rgba(0, 0, 0, 0.1); color: #1e293b; }
        .ticker-wrap { overflow: hidden; white-space: nowrap; }
        .ticker-move { display: inline-block; animation: ticker 25s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .signature-canvas { border: 2px dashed #cbd5e1; background: #fff; cursor: crosshair; touch-action: none; border-radius: 1.5rem; width: 100%; height: 200px; }
    </style>
</head>
<body class="pb-12">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // --- 1. 全域初始化 ---
        const appIdGlobal = typeof __app_id !== 'undefined' ? __app_id : 'kitchen-v16';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "", 
            authDomain: "eatjoy0706cook.firebaseapp.com",
            projectId: "eatjoy0706cook",
            storageBucket: "eatjoy0706cook.firebasestorage.app",
            messagingSenderId: "171737049178",
            appId: "1:171737049178:web:12954c7ce24c160bda1063"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const getPublicPath = (col) => `artifacts/${appIdGlobal}/public/data/${col}`;

        const ZONES = [
            { id: 'beverage', name: '飲調區' }, { id: 'light-meal', name: '輕食區' },
            { id: 'seafood', name: '海鮮區' }, { id: 'vegetable', name: '蔬菜區' },
            { id: 'meat', name: '切肉區' }, { id: 'cold-platter', name: '冷盤區' },
            { id: 'cooked-food', name: '熟食區' }, { id: 'soup', name: '湯品區' }
        ];

        // --- 2. 基礎組件與管理器 (需在調用前定義) ---

        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current) {
                    iconRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.style.width = `${size}px`;
                    i.style.height = `${size}px`;
                    iconRef.current.appendChild(i);
                    if (window.lucide) {
                        window.lucide.createIcons({
                            attrs: { width: size, height: size, class: className },
                            nameAttr: 'data-lucide'
                        });
                    }
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center"></span>;
        };

        const ChefHatIcon = ({ size = 24 }) => (
            <svg viewBox="0 0 24 24" width={size} height={size} stroke="currentColor" strokeWidth="2.5" fill="none" strokeLinecap="round" strokeLinejoin="round">
                <path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/><line x1="6" y1="17" x2="18" y2="17"/>
            </svg>
        );

        const Ticker = ({ logs }) => (
            <div className="bg-slate-900 text-white py-2.5 px-4 ticker-wrap">
                <div className="ticker-move flex gap-8 font-bold text-[10px] uppercase tracking-wider items-center">
                    {logs && logs.length > 0 ? logs.map((l, i) => (
                        <span key={i} className="flex items-center gap-2 whitespace-nowrap">
                            <span className="text-orange-500">●</span> {l.time} - {l.message}
                        </span>
                    )) : <span>歡迎使用廚房管理系統 ... 目前雲端連線正常 ... 隨時保持環境整潔 ... </span>}
                </div>
            </div>
        );

        const BackButton = ({ onClick, title }) => (
            <div className="flex items-center gap-4 mb-8 text-left border-b border-slate-200/50 pb-4">
                <button onClick={onClick} className="p-3 glass-panel rounded-2xl border active:scale-90 transition-all text-slate-800 bg-white shadow-sm"><Icon name="arrow-left" size={20}/></button>
                <h2 className="text-2xl font-black text-slate-800 tracking-tighter leading-tight">{title}</h2>
            </div>
        );

        const SectionItem = ({ title, iconName, onClick }) => (
            <div onClick={onClick} className="glass-panel p-6 rounded-[2rem] flex items-center justify-between active:bg-slate-50 cursor-pointer group transition-all mb-3 text-left bg-white shadow-sm">
                <div className="flex items-center gap-4 text-slate-400 group-active:text-orange-500 font-bold">
                    {iconName && <Icon name={iconName} size={18} />}
                    <span className="text-slate-800 text-sm leading-none">{title}</span>
                </div>
                <Icon name="chevron-right" size={18} className="text-slate-300" />
            </div>
        );

        const RuleStandardBlock = ({ id, title, desc, img }) => (
            <div className="glass-panel rounded-3xl p-6 border border-slate-100 mb-4 bg-white shadow-sm flex flex-col gap-4 overflow-hidden">
                <div className="flex gap-4">
                    <div className="w-9 h-9 bg-orange-50 text-orange-600 border border-orange-100 rounded-full flex items-center justify-center text-[10px] font-black shrink-0 leading-none">{id}</div>
                    <div className="space-y-1 text-left">
                        <h3 className="font-bold text-slate-800 text-sm leading-tight">{title}</h3>
                        <p className="text-[10px] text-slate-500 leading-relaxed font-bold whitespace-pre-wrap">{desc}</p>
                    </div>
                </div>
                {img && <img src={img} className="w-full rounded-2xl border border-slate-100 shadow-inner object-cover max-h-64" alt="項目附圖" />}
            </div>
        );

        const NavCard = ({ title, onClick, colorClass, iconName }) => (
            <button onClick={onClick} className={`${colorClass} py-10 flex flex-col items-center justify-center rounded-[2.5rem] border border-slate-100 shadow-sm active:scale-95 transition-all`}>
                <Icon name={iconName} size={24} className="mb-3 opacity-60 text-slate-800" />
                <span className="font-black text-slate-800 text-base tracking-widest uppercase">{title}</span>
            </button>
        );

        const SignaturePad = ({ onSave }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            useEffect(() => {
                const canvas = canvasRef.current;
                if(!canvas) return;
                const ctx = canvas.getContext('2d');
                ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#1e293b';
            }, []);
            const getPos = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                const scaleX = canvasRef.current.width / rect.width;
                const scaleY = canvasRef.current.height / rect.height;
                return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
            };
            const startDrawing = (e) => {
                if (e.type === 'touchstart') e.preventDefault();
                const { x, y } = getPos(e);
                canvasRef.current.getContext('2d').beginPath();
                canvasRef.current.getContext('2d').moveTo(x, y);
                setIsDrawing(true);
            };
            const draw = (e) => {
                if (!isDrawing) return;
                if (e.type === 'touchmove') e.preventDefault();
                const { x, y } = getPos(e);
                canvasRef.current.getContext('2d').lineTo(x, y);
                canvasRef.current.getContext('2d').stroke();
            };
            return (
                <div className="glass-panel p-6 rounded-[2.5rem] mt-8 bg-white border border-slate-200 text-center shadow-lg">
                    <h4 className="font-black text-slate-800 mb-4 flex items-center justify-center gap-2"><Icon name="pen-tool" size={18} className="text-orange-500" />確認閱讀完畢並簽名</h4>
                    <canvas ref={canvasRef} width={600} height={300} className="signature-canvas mb-4 mx-auto" onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={()=>setIsDrawing(false)} onMouseLeave={()=>setIsDrawing(false)} onTouchStart={startDrawing} onTouchEnd={()=>setIsDrawing(false)} onTouchMove={draw}></canvas>
                    <div className="flex gap-3">
                        <button onClick={() => canvasRef.current.getContext('2d').clearRect(0,0,600,300)} className="flex-1 py-3 rounded-xl bg-slate-100 text-slate-400 font-bold text-xs shadow-sm">重寫</button>
                        <button onClick={() => onSave(canvasRef.current.toDataURL())} className="flex-[2] py-3 rounded-xl bg-orange-600 text-white font-black text-xs shadow-lg active:scale-95 transition-all">確認提交簽名</button>
                    </div>
                </div>
            );
        };

        const UniversalListManager = ({ docPath, items = [], titleLabel = "項目名稱", triggerNotify }) => {
            const [newT, setNewT] = useState(''); const [newC, setNewC] = useState(''); const [newI, setNewI] = useState(null);
            const addItem = () => {
                if (!newT || !newC) return;
                db.doc(getPublicPath(docPath)).set({ items: [...items, { title: newT, content: newC, img: newI }] }).then(() => {
                    setNewT(''); setNewC(''); setNewI(null); triggerNotify("已成功同步雲端", "success");
                });
            };
            return (
                <div className="space-y-4 text-left">
                    <div className="glass-panel p-6 rounded-[2.5rem] space-y-4 bg-white border border-slate-100 shadow-sm">
                        <input placeholder={titleLabel} value={newT} onChange={e=>setNewT(e.target.value)} className="w-full input-light p-4 rounded-xl text-sm font-bold border-slate-200 outline-none shadow-inner" />
                        <textarea placeholder="詳細描述內容..." rows="3" value={newC} onChange={e=>setNewC(e.target.value)} className="w-full input-light p-4 rounded-xl text-sm border-slate-200 outline-none shadow-inner" />
                        <label className="block w-full bg-slate-50 border border-slate-200 py-3 rounded-xl text-[10px] font-black text-center cursor-pointer text-slate-500 shadow-sm">{newI ? "✅ 圖片已就緒" : "+ 上傳附圖"}<input type="file" className="hidden" onChange={e=>{const r=new FileReader(); r.onloadend=()=>setNewI(r.result); r.readAsDataURL(e.target.files[0]);}}/></label>
                        <button onClick={addItem} className="w-full bg-orange-600 text-white font-black py-4 rounded-2xl shadow-lg uppercase text-xs active:scale-95 transition-all shadow-orange-100">新增一條至雲端</button>
                    </div>
                    <div className="space-y-2">
                        {items.map((r, i) => (
                            <div key={i} className="bg-white p-4 rounded-2xl border border-slate-100 flex gap-4 items-center shadow-sm">
                                {r.img && <img src={r.img} className="w-12 h-12 rounded-lg object-cover border shadow-sm" />}
                                <div className="flex-1 text-left"><p className="font-bold text-slate-800 text-sm line-clamp-1">{r.title}</p></div>
                                <button onClick={() => db.doc(getPublicPath(docPath)).set({ items: items.filter((_, idx)=>idx!==i) })} className="text-slate-300 hover:text-red-500 transition-colors p-1"><Icon name="trash-2" size={16} /></button>
                            </div>
                        ))}
                        {items.length === 0 && <div className="py-10 text-center text-slate-300 font-bold uppercase text-[10px]">目前尚無內容</div>}
                    </div>
                </div>
            );
        };

        // --- 3. 業務分頁組件 ---

        const AuthPage = ({ users, setCurrentUser, setCurrentPage, setIsManager, triggerNotify }) => {
            const [phone, setPhone] = useState(''); const [name, setName] = useState(''); const [mode, setMode] = useState('login');
            const [adminPass, setAdminPass] = useState('');
            const handleAuth = async () => {
                if (mode === 'admin') {
                    if (adminPass.toLowerCase() === 'eatjoy0706') { setIsManager(true); setCurrentPage('home'); triggerNotify("管理員模式已啟用", "success"); }
                    else alert('驗證碼錯誤'); return;
                }
                if (!phone) return;
                const existing = users.find(u => u.phone === phone);
                if (mode === 'register') {
                    if (existing) return alert('此號碼已註冊過');
                    const newUser = { phone, name, status: 'pending' };
                    await db.collection(getPublicPath('users')).doc(phone).set(newUser);
                    setCurrentUser(newUser); triggerNotify("申請已提交雲端", "info");
                } else {
                    if (existing) { setCurrentUser(existing); if (existing.status === 'approved') { setCurrentPage('home'); triggerNotify(`你好，${existing.name}`, "success"); } }
                    else { alert('帳號不存在，請先註冊'); setMode('register'); }
                }
            };
            return (
                <div className="p-6 pt-20 text-center page-enter">
                    <div className="bg-orange-500 w-24 h-24 rounded-[2rem] flex items-center justify-center mx-auto mb-6 text-white shadow-xl shadow-orange-100 font-black"><ChefHatIcon size={48} /></div>
                    <h2 className="text-3xl font-black text-slate-800 mb-1 tracking-tighter text-center uppercase">Kitchen OS</h2>
                    <div className="glass-panel p-8 rounded-[3rem] space-y-5 shadow-xl">
                        <div className="flex bg-slate-100 p-1.5 rounded-2xl border border-slate-200 shadow-inner">
                            <button onClick={() => setMode('login')} className={`flex-1 py-3 rounded-xl font-bold text-xs transition-all ${mode === 'login' ? 'bg-white shadow-sm text-orange-600' : 'text-slate-400'}`}>登入</button>
                            <button onClick={() => setMode('register')} className={`flex-1 py-3 rounded-xl font-bold text-xs transition-all ${mode === 'register' ? 'bg-white shadow-sm text-orange-600' : 'text-slate-400'}`}>註冊</button>
                        </div>
                        {mode === 'register' && <input type="text" placeholder="真實姓名" className="w-full input-light p-5 rounded-2xl outline-none font-bold text-center border-0 shadow-inner" value={name} onChange={e => setName(e.target.value)} />}
                        {mode === 'admin' ? <input type="password" placeholder="主管驗證碼" className="w-full input-light p-5 rounded-2xl outline-none font-bold text-center tracking-[0.5em] border-0 shadow-inner" value={adminPass} onChange={e => setAdminPass(e.target.value)} onKeyDown={(e)=>e.key==='Enter'&&handleAuth()} /> : <input type="tel" placeholder="手機號碼" className="w-full input-light p-5 rounded-2xl outline-none font-bold tracking-widest text-center border-0 shadow-inner" value={phone} onChange={e => setPhone(e.target.value)} onKeyDown={(e)=>e.key==='Enter'&&handleAuth()} />}
                        <button handleAuth onClick={handleAuth} className="w-full bg-orange-600 text-white font-black py-5 rounded-2xl shadow-lg active:scale-95 transition-all uppercase text-sm tracking-widest shadow-orange-100">進入系統</button>
                        <button onClick={() => setMode(mode === 'admin' ? 'login' : 'admin')} className="text-slate-400 font-bold text-[10px] uppercase border-b border-slate-200 pt-4 active:text-orange-500">主管管理入口</button>
                    </div>
                </div>
            );
        };

        const PendingPage = ({ onLogout }) => (
            <div className="p-10 pt-32 text-center page-enter space-y-8 h-screen bg-[#fff5f5]">
                <div className="bg-white w-24 h-24 rounded-full flex items-center justify-center mx-auto shadow-lg">
                    <Icon name="clock" size={48} className="text-orange-500 animate-pulse" />
                </div>
                <div className="space-y-2">
                    <h3 className="text-2xl font-black text-slate-800">核准等待中</h3>
                    <p className="text-slate-500 text-sm font-bold leading-relaxed px-10">您的註冊資訊已成功提交雲端。<br/>目前正在等待主管核准權限，請稍後再次登入查看。</p>
                </div>
                <button onClick={onLogout} className="text-slate-400 font-bold border-b border-slate-200 pb-1 text-sm active:text-orange-500">登出並返回登入畫面</button>
            </div>
        );

        const HomePage = ({ onNavigate, announcements, doneCount, onOpenAnn, logs }) => (
            <div className="page-enter pb-10">
                <Ticker logs={logs} />
                <div className="p-4 space-y-6 mt-2 text-left">
                    <div className="glass-panel p-6 rounded-[2.5rem] flex items-center justify-between border-l-4 border-orange-500 shadow-sm bg-white">
                        <div className="flex items-center gap-4 text-left">
                            <div className="w-14 h-14 bg-orange-50 text-orange-600 rounded-[1.5rem] flex items-center justify-center font-black text-2xl border border-orange-100">{doneCount}</div>
                            <div><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1 text-left">今日巡視進度</p><p className="text-sm font-black text-slate-800">{doneCount === ZONES.length ? "✅ 區域已全數完成" : `尚有 ${ZONES.length - doneCount} 站待處理`}</p></div>
                        </div>
                        <button onClick={() => onNavigate('inspection')} className="p-4 bg-orange-600 text-white rounded-2xl active:scale-90 transition-transform shadow-lg shadow-orange-100"><Icon name="camera" size={24}/></button>
                    </div>
                    <section>
                        <div className="flex items-center gap-2 mb-4 px-2 text-left font-black text-slate-400"><Icon name="bell" size={18} className="text-orange-500" /><span>系統最新公告</span></div>
                        <div className="space-y-3">
                            {announcements.slice(0, 3).map(ann => (
                                <div key={ann.id} onClick={() => onOpenAnn(ann)} className="glass-panel p-5 rounded-[2rem] border border-slate-100 active:bg-slate-50 cursor-pointer text-left transition-all bg-white shadow-sm">
                                    <h3 className="font-bold text-sm text-slate-800 mb-1">{ann.title}</h3>
                                    <p className="text-xs text-slate-400 line-clamp-2 leading-relaxed">{ann.content}</p>
                                </div>
                            ))}
                        </div>
                    </section>
                    <section className="grid grid-cols-2 gap-4">
                        <NavCard title="入職相關" onClick={() => onNavigate('onboarding')} colorClass="bg-blue-50/50" iconName="user-plus" />
                        <NavCard title="員工守則" onClick={() => onNavigate('rules')} colorClass="bg-emerald-50/50" iconName="book-open" />
                        <NavCard title="薪資福利" onClick={() => onNavigate('benefits')} colorClass="bg-rose-50/50" iconName="wallet" />
                        <NavCard title="本季菜單" onClick={() => onNavigate('menu')} colorClass="bg-yellow-50/50" iconName="utensils" />
                        <NavCard title="每月班表" onClick={() => onNavigate('schedule')} colorClass="bg-indigo-50/50" iconName="calendar" />
                        <NavCard title="善後巡視" onClick={() => onNavigate('inspection')} colorClass="bg-orange-50" iconName="check-square" />
                    </section>
                </div>
            </div>
        );

        const RuleDetailPage = ({ category, rulesData, onBack, user, triggerNotify, getPublicPath }) => {
            const list = rulesData[category] || [];
            const [signed, setSigned] = useState(false);
            const handleSign = async (img) => {
                if (!user) return;
                try {
                    await db.collection(getPublicPath('signatures')).doc(`${user.phone}_${category}`).set({
                        userName: user.name, phone: user.phone, category: category, signature: img, timestamp: Date.now()
                    });
                    setSigned(true); triggerNotify("簽名已完成上傳", "success");
                } catch (e) { triggerNotify("上傳失敗", "error"); }
            };
            return (
                <div className="p-4 space-y-4 page-enter pb-10 text-left">
                    <BackButton onClick={onBack} title={category} />
                    {list.length > 0 ? (
                        <>
                            {list.map((item, idx) => <RuleStandardBlock key={idx} id={idx + 1} title={item.title} desc={item.content} img={item.img} />)}
                            {!signed ? <SignaturePad onSave={handleSign} /> : <div className="glass-panel p-8 rounded-[2.5rem] bg-emerald-50 border-emerald-100 text-emerald-600 text-center font-bold font-black"><Icon name="check-circle" size={48} className="mx-auto mb-2" />您已完成簽署</div>}
                        </>
                    ) : <div className="py-20 text-center text-slate-300 font-bold uppercase glass-panel rounded-[3rem] bg-white border border-slate-100">內容載入中...</div>}
                </div>
            );
        };

        const ListDetailPage = ({ onBack, title, list }) => (
            <div className="p-4 space-y-6 page-enter pb-20 text-left">
                <BackButton onClick={onBack} title={title} />
                <div className="space-y-4">
                    {list && list.length > 0 ? list.map((item, idx) => (
                        <RuleStandardBlock key={idx} id={idx + 1} title={item.title} desc={item.content} img={item.img} />
                    )) : <div className="py-20 text-center text-slate-300 font-bold uppercase glass-panel rounded-[3rem] border border-slate-100 bg-white shadow-inner">內容尚未設定</div>}
                </div>
            </div>
        );

        const WorkRoutePage = ({ onBack, data }) => (
            <div className="p-4 space-y-6 page-enter pb-10 text-left">
                <BackButton onClick={onBack} title="上班動線" />
                <section className="glass-panel rounded-[2.5rem] p-6 border border-slate-100 mb-4 bg-white shadow-sm">
                    <div className="flex items-center gap-3 mb-4 font-black text-slate-800"><Icon name="bus" className="text-orange-500"/> 大眾運輸導引</div>
                    {data?.routeBusVideo ? <video src={data.routeBusVideo} controls className="w-full rounded-3xl shadow-sm border border-slate-100" /> : <div className="aspect-video bg-slate-50 rounded-3xl flex items-center justify-center border-2 border-dashed border-slate-200 font-black text-slate-400">影片載入中...</div>}
                </section>
                <section className="glass-panel rounded-[2.5rem] p-6 border border-slate-100 bg-white shadow-sm">
                    <div className="flex items-center gap-3 mb-4 font-black text-slate-800"><Icon name="car" className="text-orange-500"/> 騎車 / 開車導引</div>
                    {data?.routeCarVideo ? <video src={data.routeCarVideo} controls className="w-full rounded-3xl shadow-sm border border-slate-100" /> : <div className="aspect-video bg-slate-50 rounded-3xl flex items-center justify-center border-2 border-dashed border-slate-200 font-black text-slate-400">影片載入中...</div>}
                </section>
            </div>
        );

        const InspectionPage = ({ onBack, standards, completedZones, triggerNotify, getPublicPath }) => {
            const [activeZone, setActiveZone] = useState(null);
            const [uploads, setUploads] = useState({});
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);

            const handleFile = (e, idx) => {
                const r = new FileReader(); r.onloadend = () => setUploads(p => ({ ...p, [idx]: r.result })); r.readAsDataURL(e.target.files[0]);
            };

            const runAI = () => {
                const stds = standards[activeZone.id] || [];
                if (stds.length === 0) return triggerNotify("尚未設定標準照", "error");
                setLoading(true);
                setTimeout(() => {
                    const pass = Math.random() > 0.1;
                    setResult({ status: pass ? 'PASS' : 'FAIL', summary: pass ? "合格 ✅" : "不合格 ❌" });
                    if(pass && !completedZones.includes(activeZone.id)) {
                        db.doc(getPublicPath('system/progress')).set({ completedZones: [...completedZones, activeZone.id] }, { merge: true });
                    }
                    setLoading(false);
                }, 1500);
            };
            if(activeZone) return (
                <div className="p-4 space-y-6 page-enter pb-24 text-left">
                    <button onClick={()=>{setActiveZone(null);setResult(null);setUploads({});}} className="p-3 bg-white rounded-2xl shadow-sm border active:scale-90 transition-all shadow-sm"><Icon name="arrow-left" size={20}/></button>
                    <div className="space-y-4">
                        {(standards[activeZone.id] || []).map((item, i) => (
                            <div key={i} className="glass-panel p-4 rounded-[2rem] border border-slate-100 bg-white shadow-sm">
                                <p className="text-[11px] font-black text-slate-700 mb-3 bg-slate-50 p-3 rounded-xl flex items-center gap-2 border border-slate-100"><Icon name="info" size={14} className="text-orange-500" />要求：{item.note || "無說明"}</p>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="text-center"><span className="text-[9px] font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full uppercase">標準照</span><img src={item.url} className="w-full aspect-square object-cover rounded-2xl border mt-2 shadow-sm" /></div>
                                    <div className="text-center"><span className="text-[9px] font-black text-orange-600 bg-orange-50 px-2 py-1 rounded-full uppercase">實拍照</span>{uploads[i] ? <div className="relative mt-2"><img src={uploads[i]} className="w-full aspect-square object-cover rounded-2xl border shadow-sm" /></div> : <label className="w-full aspect-square bg-slate-50 border-2 border-dashed rounded-2xl flex flex-col items-center justify-center mt-2 cursor-pointer shadow-inner hover:bg-slate-100 transition-colors"><Icon name="plus" size={20} className="text-slate-300"/><input type="file" className="hidden" onChange={(e)=>handleFile(e, i)} /></label>}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                    <button onClick={runAI} className="w-full py-5 rounded-[2rem] font-black bg-orange-600 text-white shadow-xl active:scale-95 transition-all shadow-orange-100">啟動 AI 判定</button>
                    {result && <div className={`p-8 rounded-[3rem] border-4 ${result.status==='PASS'?'bg-emerald-50 border-emerald-200 text-emerald-700 animate-bounce':'bg-red-50 border-red-200 text-red-700'} text-center mt-4 shadow-sm`}><h4 className="text-2xl font-black">{result.status==='PASS'?'合格 ✅':'需改善 ❌'}</h4></div>}
                </div>
            );
            return (
                <div className="p-4 space-y-4 page-enter pb-20 text-left">
                    <BackButton onClick={onBack} title="善後巡視" />
                    <div className="bg-gradient-to-r from-orange-500 to-orange-400 p-7 rounded-[2.5rem] text-white shadow-lg flex justify-between items-center mb-6">
                        <div><p className="text-[10px] font-black uppercase opacity-60 mb-1 text-left">當日完成度</p><p className="text-3xl font-black">{completedZones.length} / {ZONES.length}</p></div>
                        <div className="w-14 h-14 rounded-full border-4 border-white/20 flex items-center justify-center font-black text-xs">{Math.round((completedZones.length/ZONES.length)*100)}%</div>
                    </div>
                    <div className="grid grid-cols-1 gap-3">
                        {ZONES.map(z => (<SectionItem key={z.id} title={z.name} iconName={completedZones.includes(z.id) ? "check-circle" : "camera"} onClick={() => setActiveZone(z)} />))}
                    </div>
                </div>
            );
        };

        const AdminPage = ({ onBack, onLogout, announcements, schedules, standards, users, triggerNotify, menu, onboarding, benefits, rulesData, getPublicPath }) => {
            const [tab, setTab] = useState('members');
            const [subCat, setSubCat] = useState('list');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedZone, setSelectedZone] = useState(ZONES[0].id);

            const handleVideoUpload = (e, field) => {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader(); r.onloadend = () => db.doc(getPublicPath('system/onboarding')).set({ [field]: r.result }, {merge:true});
                r.readAsDataURL(f);
                triggerNotify("影片已提交上傳", "info");
            };

            return (
                <div className="p-4 pb-24 page-enter text-left">
                    <div className="flex justify-between items-center mb-6"><BackButton onClick={onBack} title="後台管理系統" /><button onClick={onLogout} className="bg-red-50 text-red-600 font-black text-[10px] px-4 py-2 rounded-full border border-red-100 shadow-sm active:scale-90">登出登入</button></div>
                    <div className="flex bg-slate-100 p-1.5 rounded-2xl border border-slate-200 overflow-x-auto no-scrollbar gap-1.5 mb-6 shadow-inner">
                        {[{id:'members',n:'審核'},{id:'menu',n:'菜單'},{id:'content',n:'公告'},{id:'onboard',n:'入職'},{id:'benefit',n:'福利'},{id:'rules',n:'守則'},{id:'schedules',n:'班表'},{id:'safety',n:'巡視'},{id:'sign',n:'簽署'}].map(t => (
                            <button key={t.id} onClick={()=>setTab(t.id)} className={`shrink-0 px-5 py-2.5 rounded-xl text-xs font-bold transition-all ${tab===t.id?'bg-orange-600 text-white shadow-md':'text-slate-400'}`}>{t.n}</button>
                        ))}
                    </div>

                    <div className="space-y-4">
                        {tab === 'members' && users.map(u=>(<div key={u.phone} className="glass-panel p-5 rounded-[2rem] border border-slate-100 flex justify-between items-center bg-white shadow-sm mb-2 shadow-sm shadow-orange-50/50"><div><p className="font-bold text-slate-800 mb-1">{u.name}</p><p className="text-[10px] text-slate-400">{u.phone}</p></div><div className="flex gap-2">{u.status==='pending'?<button onClick={()=>db.collection(getPublicPath('users')).doc(u.phone).update({status:'approved'})} className="bg-emerald-600 text-white px-5 py-2.5 rounded-xl text-[10px] font-black shadow-md">核准</button>:<span className="text-[9px] font-black text-emerald-600 border border-emerald-100 px-3 py-2 rounded-lg bg-emerald-50">已核准</span>}<button onClick={()=>db.collection(getPublicPath('users')).doc(u.phone).delete()} className="p-2 text-slate-200 hover:text-red-500 transition-colors"><Icon name="trash-2" size={16}/></button></div></div>))}
                        
                        {tab === 'onboard' && (<div><div className="flex bg-slate-100 p-1 rounded-xl mb-4 shadow-inner">{[{id:'list',n:'清單'},{id:'parking',n:'停車'},{id:'video',n:'影片'}].map(c=>(<button key={c.id} onClick={()=>setSubCat(c.id)} className={`flex-1 py-2 rounded-lg text-[10px] font-bold ${subCat===c.id?'bg-white text-orange-600 shadow-sm':'text-slate-400'}`}>{c.n}</button>))}</div>
                            {subCat === 'video' ? (
                                <div className="space-y-4 bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest text-left mb-2">動線引導影片管理</p>
                                    <label className="bg-slate-900 text-white w-full block py-4 rounded-xl text-[10px] font-black cursor-pointer text-center uppercase shadow-lg mb-2 active:scale-95 transition-all">上傳大眾運輸影片<input type="file" className="hidden" accept="video/*" onChange={e=>handleVideoUpload(e, 'routeBusVideo')}/></label>
                                    <label className="bg-slate-900 text-white w-full block py-4 rounded-xl text-[10px] font-black cursor-pointer text-center uppercase shadow-lg active:scale-95 transition-all">上傳自行前往影片<input type="file" className="hidden" accept="video/*" onChange={e=>handleVideoUpload(e, 'routeCarVideo')}/></label>
                                </div>
                            ) : <UniversalListManager docPath={subCat==='list'?'system/onboarding_list':'system/onboarding_parking'} items={subCat==='list'?(onboarding?.list || []):(onboarding?.parking || [])} triggerNotify={triggerNotify} />}
                        </div>)}

                        {tab === 'menu' && <UniversalListManager docPath="system/menu_list" items={menu?.items || []} titleLabel="菜單項目名稱" triggerNotify={triggerNotify} />}
                        {tab === 'content' && <UniversalListManager docPath="system/announcements_list" items={announcements || []} titleLabel="公告標題" triggerNotify={triggerNotify} />}
                        {tab === 'benefit' && (<div><div className="flex bg-slate-100 p-1 rounded-xl mb-4 shadow-inner">{[{id:'eval',n:'考核'},{id:'wel',n:'福利'}].map(c=>(<button key={c.id} onClick={()=>setSubCat(c.id)} className={`flex-1 py-2 rounded-lg text-[10px] font-bold ${subCat===c.id?'bg-white text-orange-600 shadow-sm':'text-slate-400'}`}>{c.n}</button>))}</div><UniversalListManager docPath={subCat==='eval'?'system/benefits_eval':'system/benefits_welfare'} items={subCat==='eval'?(benefits?.evaluation || []):(benefits?.welfare || [])} triggerNotify={triggerNotify} /></div>)}

                        {tab === 'rules' && (<div><div className="flex bg-slate-100 p-1 rounded-xl mb-4 shadow-inner">{['廚房規則','食品衛生安全','設備操作安全','出缺勤規範'].map(c=>(<button key={c} onClick={()=>setSubCat(c)} className={`flex-1 py-2 rounded-lg text-[10px] font-bold ${subCat===c?'bg-white text-orange-600 shadow-sm':'text-slate-400'}`}>{c.slice(0,2)}</button>))}</div><UniversalListManager docPath={`rules/${subCat}`} items={rulesData[subCat] || []} triggerNotify={triggerNotify} /></div>)}

                        {tab === 'schedules' && (<div className="glass-panel p-6 rounded-[2.5rem] space-y-4 bg-white border border-slate-100 shadow-sm text-center shadow-sm"><input type="month" value={selectedMonth} onChange={e=>setSelectedMonth(e.target.value)} className="w-full input-light p-3 rounded-xl text-sm border-slate-200 outline-none shadow-inner" /><label className="bg-orange-600 text-white w-full block py-4 rounded-2xl text-[11px] font-black cursor-pointer text-center shadow-lg active:scale-95 transition-all mt-4 shadow-orange-100">上傳班表圖檔<input type="file" multiple className="hidden" onChange={e => { const f = Array.from(e.target.files); f.forEach(file => { const r = new FileReader(); r.onloadend = () => db.collection(getPublicPath('schedules')).doc(selectedMonth).set({ images: [...(schedules[selectedMonth] || []), r.result] }); r.readAsDataURL(file); }); }}/></label></div>)}

                        {tab === 'safety' && (
                            <div className="glass-panel p-6 rounded-[2.5rem] space-y-4 bg-white border border-slate-100 shadow-sm text-left shadow-sm">
                                <select value={selectedZone} onChange={e=>setSelectedZone(e.target.value)} className="w-full input-light p-4 rounded-xl text-sm font-bold border-slate-200 outline-none shadow-inner">{ZONES.map(z => <option key={z.id} value={z.id}>{z.name}</option>)}</select>
                                <div className="bg-slate-50 p-4 rounded-2xl space-y-3 border border-slate-100 shadow-inner"><input id="std-note" placeholder="檢查重點標註..." className="w-full input-light p-3 rounded-xl text-xs border-slate-200 outline-none shadow-sm shadow-inner" /><label className="bg-slate-900 text-white w-full block py-4 rounded-xl text-[10px] font-black text-center cursor-pointer uppercase shadow-lg active:scale-95 transition-all">上傳標準對照圖<input type="file" className="hidden" onChange={e=>{const f=e.target.files[0]; if(f){const r=new FileReader(); const note=document.getElementById('std-note').value; r.onloadend=()=>{ db.collection(getPublicPath('standards')).doc(selectedZone).set({ items: [...(standards[selectedZone] || []), {url: r.result, note: note}] }); document.getElementById('std-note').value=''; triggerNotify("標準圖已同步", "success"); }; r.readAsDataURL(f);}}}/></label></div>
                                <div className="space-y-3">{(standards[selectedZone] || []).map((item, i) => (<div key={i} className="bg-white p-3 rounded-2xl border border-slate-100 flex gap-4 items-start shadow-sm"><img src={item.url} className="w-16 h-16 rounded-xl object-cover border shadow-sm" /><div className="flex-1 text-left text-xs text-slate-600 line-clamp-2">{item.note || "未設定說明"}</div><button onClick={()=>{db.collection(getPublicPath('standards')).doc(selectedZone).set({items: standards[selectedZone].filter((_,idx)=>idx!==i)});}} className="p-2 text-slate-300 hover:text-red-500 transition-colors"><Icon name="x" size={14}/></button></div>))}</div>
                            </div>
                        )}

                        {tab === 'sign' && <div className="py-20 text-center glass-panel rounded-[3rem] text-slate-300 font-bold uppercase tracking-widest text-xs border border-slate-100 bg-white">目前尚無簽署記錄</div>}
                    </div>
                </div>
            );
        };

        // --- 4. 主應用程式 (App) ---

        const App = () => {
            const [currentPage, setCurrentPage] = useState('auth');
            const [isManager, setIsManager] = useState(false);
            const [fbReady, setFbReady] = useState(false);
            const [user, setUser] = useState(null);
            const [notifications, setNotifications] = useState([]);
            const [users, setUsers] = useState([]);
            const [currentUser, setCurrentUser] = useState(() => JSON.parse(localStorage.getItem('k_active_user')) || null);
            const [announcements, setAnnouncements] = useState([]);
            const [schedules, setSchedules] = useState({});
            const [standards, setStandards] = useState({});
            const [completedZones, setCompletedZones] = useState([]);
            const [menuData, setMenuData] = useState({});
            const [onboardingData, setOnboardingData] = useState({});
            const [benefitsData, setBenefitsData] = useState({});
            const [rulesData, setRulesData] = useState({});
            const [selectedAnn, setSelectedAnn] = useState(null);
            const [selectedCat, setSelectedCat] = useState(null);

            const triggerNotify = useCallback((msg, type = "info") => {
                const id = Date.now();
                setNotifications(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), 4000);
            }, []);

            useEffect(() => {
                const init = async () => {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (token) await auth.signInWithCustomToken(token).catch(() => auth.signInAnonymously());
                    else await auth.signInAnonymously();
                    setFbReady(true);
                };
                init();
                const unsub = auth.onAuthStateChanged(u => { setUser(u); if(!u) setFbReady(false); });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user) return;
                const err = (e) => console.error(e);
                db.collection(getPublicPath('users')).onSnapshot(s => setUsers(s.docs.map(d => d.data())), err);
                db.doc(getPublicPath('system/progress')).onSnapshot(d => d.exists && setCompletedZones(d.data().completedZones || []), err);
                db.collection(getPublicPath('schedules')).onSnapshot(s => { const m = {}; s.docs.forEach(d => m[d.id] = d.data().images); setSchedules(m); }, err);
                db.collection(getPublicPath('standards')).onSnapshot(s => { const m = {}; s.docs.forEach(d => m[d.id] = d.data().items || []); setStandards(m); }, err);
                db.doc(getPublicPath('system/onboarding_list')).onSnapshot(d => d.exists && setOnboardingData(p => ({...p, list: d.data().items})), err);
                db.doc(getPublicPath('system/onboarding_parking')).onSnapshot(d => d.exists && setOnboardingData(p => ({...p, parking: d.data().items})), err);
                db.doc(getPublicPath('system/onboarding')).onSnapshot(d => d.exists && setOnboardingData(p => ({...p, ...d.data()})), err);
                db.doc(getPublicPath('system/benefits_eval')).onSnapshot(d => d.exists && setBenefitsData(p => ({...p, evaluation: d.data().items})), err);
                db.doc(getPublicPath('system/benefits_welfare')).onSnapshot(d => d.exists && setBenefitsData(p => ({...p, welfare: d.data().items})), err);
                db.doc(getPublicPath('system/menu_list')).onSnapshot(d => d.exists && setMenuData(p => ({...p, items: d.data().items})), err);
                db.doc(getPublicPath('system/announcements_list')).onSnapshot(d => d.exists && setAnnouncements(d.data().items || []), err);
                ['廚房規則','食品衛生安全','設備操作安全','出缺勤規範'].forEach(cat => db.doc(getPublicPath(`rules/${cat}`)).onSnapshot(d => d.exists && setRulesData(prev => ({ ...prev, [cat]: d.data().items || [] })), err));
            }, [user]);

            useEffect(() => { if (currentUser) localStorage.setItem('k_active_user', JSON.stringify(currentUser)); }, [currentUser]);

            const logout = () => { setCurrentUser(null); setIsManager(false); setCurrentPage('auth'); localStorage.removeItem('k_active_user'); };

            if (fbReady && !isManager && currentUser?.status === 'pending') {
                return <PendingPage onLogout={logout} />;
            }

            const renderPage = () => {
                switch(currentPage) {
                    case 'home': return <HomePage onNavigate={setCurrentPage} announcements={announcements} doneCount={completedZones.length} onOpenAnn={(a)=>{setSelectedAnn(a); setCurrentPage('annDetail');}} logs={[]} />;
                    case 'rules': return <div className="p-4 space-y-3 page-enter text-left"><BackButton onClick={()=>setCurrentPage('home')} title="員工守則" /><SectionItem title="廚房規則" iconName="book-open" onClick={()=>{setSelectedCat("廚房規則"); setCurrentPage('ruleDetail');}} /><SectionItem title="食品衛生安全" iconName="shield-check" onClick={()=>{setSelectedCat("食品衛生安全"); setCurrentPage('ruleDetail');}} /><SectionItem title="設備操作安全" iconName="flame" onClick={()=>{setSelectedCat("設備操作安全"); setCurrentPage('ruleDetail');}} /><SectionItem title="出缺勤規範" iconName="clock" onClick={()=>{setSelectedCat("出缺勤規範"); setCurrentPage('ruleDetail');}} /></div>;
                    case 'ruleDetail': return <RuleDetailPage category={selectedCat} rulesData={rulesData} onBack={()=>setCurrentPage('rules')} user={currentUser} triggerNotify={triggerNotify} getPublicPath={getPublicPath} />;
                    case 'benefits': return <div className="p-4 space-y-4 page-enter text-left"><BackButton onClick={()=>setCurrentPage('home')} title="薪資福利" /><SectionItem title="考核加給標準" iconName="coins" onClick={()=>setCurrentPage('benefit-eval')} /><SectionItem title="員工相關福利" iconName="heart" onClick={()=>setCurrentPage('benefit-wel')} /></div>;
                    case 'benefit-eval': return <ListDetailPage onBack={()=>setCurrentPage('benefits')} title="考核標準" list={benefitsData?.evaluation} />;
                    case 'benefit-wel': return <ListDetailPage onBack={()=>setCurrentPage('benefits')} title="福利項目" list={benefitsData?.welfare} />;
                    case 'onboarding': return <div className="p-4 space-y-4 page-enter text-left"><BackButton onClick={()=>setCurrentPage('home')} title="入職相關" /><SectionItem title="員工準備清單" iconName="list-checks" onClick={()=>setCurrentPage('onboard-list')} /><SectionItem title="停車資訊指引" iconName="car" onClick={()=>setCurrentPage('onboard-parking')} /><SectionItem title="上班動線引導" iconName="navigation" onClick={()=>setCurrentPage('workRoute')} /></div>;
                    case 'onboard-list': return <ListDetailPage onBack={()=>setCurrentPage('onboarding')} title="準備清單" list={onboardingData?.list} />;
                    case 'onboard-parking': return <ListDetailPage onBack={()=>setCurrentPage('onboarding')} title="停車資訊" list={onboardingData?.parking} />;
                    case 'workRoute': return <WorkRoutePage onBack={()=>setCurrentPage('onboarding')} data={onboardingData} />;
                    case 'menu': return <ListDetailPage onBack={()=>setCurrentPage('home')} title="本季菜單" list={menuData?.items} />;
                    case 'schedule': return (<div className="p-4 space-y-6 page-enter pb-20 text-left"><BackButton onClick={()=>setCurrentPage('home')} title="每月班表" /><div className="space-y-4">{Object.entries(schedules).sort((a,b)=>b[0].localeCompare(a[0])).map(([m, d]) => (<div key={m} className="glass-panel p-2 rounded-[2.5rem] border border-slate-100 mb-4 bg-white shadow-sm shadow-sm shadow-orange-50/50"><p className="text-xs font-black text-slate-800 p-4 uppercase tracking-widest bg-slate-50 rounded-t-[2rem] border-b">{m.replace('-','年')}月 班表資料</p><div className="p-2 space-y-2">{d.map((img,i)=><img key={i} src={img} className="w-full rounded-[1.5rem] border border-slate-100 shadow-sm" />)}</div></div>))}</div></div>);
                    case 'inspection': return <InspectionPage onBack={()=>setCurrentPage('home')} standards={standards} completedZones={completedZones} triggerNotify={triggerNotify} getPublicPath={getPublicPath} />;
                    case 'admin': return <AdminPage onBack={()=>setCurrentPage('home')} onLogout={logout} announcements={announcements} schedules={schedules} standards={standards} users={users} triggerNotify={triggerNotify} menu={menuData} onboarding={onboardingData} benefits={benefitsData} rulesData={rulesData} getPublicPath={getPublicPath} />;
                    case 'annDetail': return (<div className="p-4 page-enter pb-10 text-left"><BackButton onClick={()=>setCurrentPage('home')} title="公告詳情" /><div className="glass-panel rounded-[3rem] p-8 border-l-4 border-orange-500 shadow-2xl mb-8 bg-white text-left shadow-xl shadow-orange-500/10"><h1 className="text-2xl font-black text-slate-800 mb-2 leading-tight">{selectedAnn?.title}</h1><p className="text-[10px] text-slate-400 font-bold mb-8 border-b border-slate-100 pb-4 uppercase tracking-widest">{new Date(selectedAnn?.timestamp || Date.now()).toLocaleDateString()} • 官方系統發佈</p><div className="text-sm text-slate-600 leading-relaxed whitespace-pre-wrap">{selectedAnn?.content}</div></div><button onClick={()=>setCurrentPage('home')} className="w-full py-5 bg-slate-900 text-white font-black rounded-2xl shadow-xl active:scale-95 transition-all uppercase tracking-widest">返回首頁導覽</button></div>);
                    default: return <HomePage onNavigate={setCurrentPage} announcements={announcements} doneCount={completedZones.length} logs={[]} onOpenAnn={(a)=>{setSelectedAnn(a); setCurrentPage('annDetail');}} />;
                }
            };

            return (
                <div className="min-h-screen flex flex-col bg-[#fff5f5]">
                    <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[1000] w-full max-w-xs space-y-3 pointer-events-none px-4 text-left">
                        {notifications.map(n => (
                            <div key={n.id} className={`toast-enter p-5 rounded-[2rem] shadow-2xl flex items-center gap-4 glass-panel border-l-4 ${n.type === 'success' ? 'border-l-emerald-500 text-emerald-700' : n.type === 'error' ? 'border-l-red-500 text-red-700' : 'border-l-orange-500 text-orange-700'}`}>
                                <Icon name={n.type === 'success' ? 'check-circle' : n.type === 'error' ? 'alert-triangle' : 'info'} size={24} className="shrink-0" /><span className="font-bold text-xs leading-tight text-left">{n.msg}</span>
                            </div>
                        ))}
                    </div>
                    <header className="p-5 sticky top-0 z-50 flex justify-between items-center bg-white/80 backdrop-blur-md border-b border-slate-100">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => (isManager || currentUser?.status === 'approved') && setCurrentPage('home')}>
                            <div className="bg-orange-600 p-2 rounded-xl text-white shadow-lg shadow-orange-100"><ChefHatIcon size={20}/></div>
                            <span className="font-black text-xl tracking-tighter text-slate-800 uppercase leading-none">Kitchen <span className="text-orange-600">OS</span></span>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => isManager ? setCurrentPage('admin') : setCurrentPage('home')} className="text-slate-400 hover:text-slate-600 transition-colors active:scale-90"><Icon name={isManager ? "settings" : "bell"} size={22} /></button>
                            {(currentUser || isManager) && <button onClick={logout} className="p-1 text-slate-300 hover:text-red-400 transition-colors active:scale-90"><Icon name="log-out" size={20} /></button>}
                        </div>
                    </header>
                    <main className="flex-grow max-w-lg mx-auto w-full">
                        {(!fbReady) ? (
                            <div className="p-20 text-center flex flex-col items-center gap-4 h-screen justify-center"><Icon name="loader-2" className="animate-spin text-orange-500" size={48}/><p className="text-slate-400 font-bold text-xs uppercase tracking-widest">建立雲端加密連線中...</p></div>
                        ) : (!isManager && !currentUser) ? (
                            <AuthPage users={users} setCurrentUser={setCurrentUser} setCurrentPage={setCurrentPage} setIsManager={setIsManager} triggerNotify={triggerNotify} getPublicPath={getPublicPath} />
                        ) : renderPage()}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
