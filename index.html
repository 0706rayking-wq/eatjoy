<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen OS - ä¼æ¥­ç‰ˆ</title>
    <!-- å¼•å…¥æ ¸å¿ƒåº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK (ç›¸å®¹æ¨¡å¼ v8) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        :root { 
            --brand-orange: #f97316; 
            --bg-light: #fff5f5; 
        }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: var(--bg-light); 
            color: #1e293b; 
            overflow-x: hidden; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .page-enter { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .toast-enter { animation: slideDown 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes slideDown { from { opacity: 0; transform: translate(-50%, -100%); } to { opacity: 1; transform: translate(-50%, 0); } }
        .glass-panel { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.5); 
            box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.04); 
        }
        .input-light { background: #ffffff; border: 1px solid rgba(0, 0, 0, 0.1); color: #1e293b; }
        .ticker-wrap { overflow: hidden; white-space: nowrap; }
        .ticker-move { display: inline-block; animation: ticker 25s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .signature-canvas { border: 2px dashed #cbd5e1; background: #fff; cursor: crosshair; touch-action: none; border-radius: 1.5rem; width: 100%; height: 200px; }
    </style>
</head>
<body class="pb-12">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // --- 1. é…ç½®èˆ‡æ ¸å¿ƒå¸¸æ•¸ ---
        const appIdGlobal = 'kitchen-v16';
        const firebaseConfig = {
            apiKey: "AIzaSyA3zTUa8Whw5X_jEJzqBTkQIPWWq84koHY",
            authDomain: "nangangeatjoycook.firebaseapp.com",
            projectId: "nangangeatjoycook",
            storageBucket: "nangangeatjoycook.firebasestorage.app",
            messagingSenderId: "976247626913",
            appId: "1:976247626913:web:103bdd5c5c2fcc9a48e4e0",
            measurementId: "G-JYWNHMJV0T"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const getPublicPath = (col) => `artifacts/${appIdGlobal}/public/data/${col}`;

        const ZONES = [
            { id: 'beverage', name: 'é£²èª¿å€' }, { id: 'light-meal', name: 'è¼•é£Ÿå€' },
            { id: 'seafood', name: 'æµ·é®®å€' }, { id: 'vegetable', name: 'è”¬èœå€' },
            { id: 'meat', name: 'åˆ‡è‚‰å€' }, { id: 'cold-platter', name: 'å†·ç›¤å€' },
            { id: 'cooked-food', name: 'ç†Ÿé£Ÿå€' }, { id: 'soup', name: 'æ¹¯å“å€' }
        ];

        const RULE_CATEGORIES = ['å»šæˆ¿è¦å‰‡', 'é£Ÿå“è¡›ç”Ÿå®‰å…¨', 'è¨­å‚™æ“ä½œå®‰å…¨', 'å‡ºç¼ºå‹¤è¦ç¯„'];

        // --- å·¥å…·èˆ‡æ¨æ’­å‡½å¼ ---
        const compressImage = (base64Str, maxWidth = 800, quality = 0.5) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height;
                    if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            });
        };

        // --- é‡è¦ï¼šæ¯æ¬¡æ›´æ–° GAS ä»£ç¢¼ä¸¦é‡æ–°éƒ¨ç½²å¾Œï¼Œè«‹ç¢ºä¿æ­¤ç¶²å€æ˜¯æœ€æ–°çš„ ---
        const GAS_BRIDGE_URL = "https://script.google.com/macros/s/AKfycbyuG1vuNfyqU7gY4o4QpPakBLeWEHgfdTRRSfgcjMZF8mg1GEd48PvavKE7cYNm6dJN/exec";

        const triggerLineAlert = async (type, payload = {}) => {
            try {
                // ä½¿ç”¨ text/plain ä¾†è¦é¿æŸäº› CORS é™åˆ¶ï¼ŒGAS çš„ doPost å¯ä»¥è™•ç†
                await fetch(GAS_BRIDGE_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ type: type, payload: payload })
                });
            } catch (e) { console.error("LINE æ¨æ’­ç™¼é€å¤±æ•—", e); }
        };

        const getBusinessCycleKey = () => {
            const now = new Date();
            const cycleDate = new Date(now);
            if (now.getHours() < 20) cycleDate.setDate(now.getDate() - 1);
            return cycleDate.toISOString().split('T')[0]; 
        };

        // --- 2. åŸºç¤çµ„ä»¶ ---

        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    iconRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    iconRef.current.appendChild(i);
                    window.lucide.createIcons({ attrs: { width: size, height: size, class: className }, nameAttr: 'data-lucide' });
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center"></span>;
        };

        const ChefHatIcon = ({ size = 24 }) => (
            <svg viewBox="0 0 24 24" width={size} height={size} stroke="currentColor" strokeWidth="2.5" fill="none" strokeLinecap="round" strokeLinejoin="round">
                <path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/><line x1="6" y1="17" x2="18" y2="17"/>
            </svg>
        );

        const Ticker = ({ text }) => (
            <div className="bg-slate-900 text-white py-2.5 px-4 ticker-wrap">
                <div className="ticker-move flex gap-8 font-bold text-[11px] uppercase tracking-wider items-center">
                    <span className="flex items-center gap-2 whitespace-nowrap"><span className="text-orange-500">â—</span> {text || "æ­¡è¿ä½¿ç”¨ Kitchen OS å»šæˆ¿ç®¡ç†ç³»çµ± ... "}</span>
                    <span className="flex items-center gap-2 whitespace-nowrap"><span className="text-orange-500">â—</span> {text || "æ­¡è¿ä½¿ç”¨ Kitchen OS å»šæˆ¿ç®¡ç†ç³»çµ± ... "}</span>
                </div>
            </div>
        );

        const BackButton = ({ onClick, title }) => (
            <div className="flex items-center gap-4 mb-8 text-left border-b border-slate-200/50 pb-4">
                <button onClick={onClick} className="p-3 glass-panel rounded-2xl border active:scale-90 transition-all bg-white shadow-sm"><Icon name="arrow-left" size={20}/></button>
                <h2 className="text-2xl font-black text-slate-800 tracking-tighter leading-tight font-bold">{title}</h2>
            </div>
        );

        const SectionItem = ({ title, iconName, onClick }) => (
            <div onClick={onClick} className="glass-panel p-6 rounded-[2rem] flex items-center justify-between active:bg-slate-50 cursor-pointer group transition-all mb-3 text-left bg-white shadow-sm">
                <div className="flex items-center gap-4 text-slate-400 group-active:text-orange-500 font-bold">
                    {iconName && <Icon name={iconName} size={18} />}
                    <span className="text-slate-800 text-sm font-bold leading-none">{title}</span>
                </div>
                <Icon name="chevron-right" size={18} className="text-slate-300" />
            </div>
        );

        const NavCard = ({ title, onClick, colorClass, iconName }) => (
            <button onClick={onClick} className={`${colorClass} py-10 flex flex-col items-center justify-center rounded-[2.5rem] border border-slate-100 shadow-sm active:scale-95 transition-all`}>
                <Icon name={iconName} size={24} className="mb-3 opacity-60 text-slate-800 font-bold" />
                <span className="font-black text-slate-800 text-sm tracking-widest uppercase font-bold">{title}</span>
            </button>
        );

        const RuleStandardBlock = ({ id, title, desc, img }) => (
            <div className="glass-panel rounded-3xl p-6 border border-slate-100 mb-4 bg-white shadow-sm flex flex-col gap-4 text-left shadow-sm">
                <div className="flex gap-4">
                    <div className="w-9 h-9 bg-orange-50 text-orange-600 border border-orange-100 rounded-full flex items-center justify-center text-[10px] font-black shrink-0 font-bold">{id}</div>
                    <div className="space-y-1">
                        <h3 className="font-bold text-blue-600 text-sm leading-tight font-black">{title}</h3>
                        <p className="text-[10px] text-black leading-relaxed font-bold whitespace-pre-wrap">{desc}</p>
                    </div>
                </div>
                {img && <img src={img} className="w-full rounded-2xl border border-slate-100 shadow-inner object-cover max-h-64" alt="é™„åœ–" />}
            </div>
        );

        const UniversalListManager = ({ docPath, items = [], titleLabel = "åç¨±", triggerNotify }) => {
            const [newT, setNewT] = useState(''); const [newC, setNewC] = useState(''); const [newI, setNewI] = useState(null);
            const addItem = async () => {
                if (!newT.trim() || !newC.trim()) return triggerNotify("æ¨™é¡Œèˆ‡å…§å®¹ä¸èƒ½ç‚ºç©º", "error");
                let imgToSave = newI;
                if (newI) imgToSave = await compressImage(newI);
                const newItem = { id: crypto.randomUUID(), title: newT.trim(), content: newC.trim(), img: imgToSave, timestamp: Date.now() };
                db.doc(getPublicPath(docPath)).set({ items: [...items, newItem] }).then(() => {
                    if (docPath === 'system/announcements_list') triggerLineAlert("ANNOUNCEMENT", { title: newT, content: newC });
                    setNewT(''); setNewC(''); setNewI(null); triggerNotify("ç™¼ä½ˆæˆåŠŸ", "success");
                }).catch(() => triggerNotify("å­˜æª”å¤±æ•— (æª”æ¡ˆå¤ªå¤§)", "error"));
            };
            const deleteItem = (id) => {
                db.doc(getPublicPath(docPath)).set({ items: items.filter(i => i.id !== id) }).then(() => triggerNotify("é …ç›®å·²åˆªé™¤", "info"));
            };
            return (
                <div className="space-y-4">
                    <div className="glass-panel p-6 rounded-[2.5rem] space-y-4 bg-white shadow-sm shadow-orange-50/10">
                        <input placeholder={titleLabel} value={newT} onChange={e=>setNewT(e.target.value)} className="w-full input-light p-4 rounded-xl text-sm font-bold outline-none font-bold" />
                        <textarea placeholder="è©³ç´°æè¿°..." rows="3" value={newC} onChange={e=>setNewC(e.target.value)} className="w-full input-light p-4 rounded-xl text-sm outline-none font-bold" />
                        <label className="block w-full bg-slate-50 border border-slate-200 py-3 rounded-xl text-[10px] font-black text-center cursor-pointer">{newI ? "âœ… åœ–ç‰‡å·²å°±ç·’" : "+ ä¸Šå‚³é™„åœ–"}<input type="file" className="hidden" accept="image/*" onChange={e=>{const file = e.target.files[0]; if (file) { const r=new FileReader(); r.onloadend=()=>setNewI(r.result); r.readAsDataURL(file); }}}/></label>
                        <button onClick={addItem} className="w-full bg-orange-600 text-white font-black py-4 rounded-2xl shadow-lg uppercase active:scale-95 transition-all font-bold">ç™¼ä½ˆ</button>
                    </div>
                    <div className="space-y-2">
                        {items.map((r) => (
                            <div key={r.id} className="bg-white p-4 rounded-2xl border border-slate-100 flex gap-4 items-center shadow-sm">
                                <div className="flex-1 text-left"><p className="font-bold text-slate-800 text-sm line-clamp-1">{r.title}</p></div>
                                <button onClick={() => deleteItem(r.id)} className="text-slate-300 hover:text-red-500 p-1 transition-colors"><Icon name="trash-2" size={16} /></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SignaturePad = ({ onSave }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const getPos = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const clientX = (e.clientX || (e.touches && e.touches[0].clientX));
                const clientY = (e.clientY || (e.touches && e.touches[0].clientY));
                const x = (clientX - rect.left) * (canvasRef.current.width / rect.width);
                const y = (clientY - rect.top) * (canvasRef.current.height / rect.height);
                return { x, y };
            };
            const startDrawing = (e) => {
                if (e.type === 'touchstart') e.preventDefault();
                const pos = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#1e293b';
                ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
                setIsDrawing(true);
            };
            const draw = (e) => {
                if (!isDrawing) return;
                const pos = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.lineTo(pos.x, pos.y); ctx.stroke();
            };
            return (
                <div className="glass-panel p-6 rounded-[2.5rem] mt-8 bg-white border border-slate-200 text-center shadow-lg">
                    <h4 className="font-black text-slate-800 mb-4 flex items-center justify-center gap-2 font-bold"><Icon name="pen-tool" size={18} className="text-orange-500" />ç¢ºèªé–±è®€å®Œç•¢ä¸¦ç°½å</h4>
                    <canvas ref={canvasRef} width={600} height={300} className="signature-canvas mb-4 mx-auto shadow-inner" onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={()=>setIsDrawing(false)} onMouseLeave={()=>setIsDrawing(false)} onTouchStart={startDrawing} onTouchEnd={()=>setIsDrawing(false)} onTouchMove={draw}></canvas>
                    <div className="flex gap-3">
                        <button onClick={() => canvasRef.current.getContext('2d').clearRect(0,0,600,300)} className="flex-1 py-3 rounded-xl bg-slate-100 text-slate-400 font-bold text-xs uppercase">é‡å¯«</button>
                        <button onClick={() => onSave(canvasRef.current.toDataURL())} className="flex-[2] py-3 rounded-xl bg-orange-600 text-white font-black text-xs uppercase active:scale-95 transition-all">æäº¤ç°½ç½²</button>
                    </div>
                </div>
            );
        };

        // --- 3. é é¢çµ„ä»¶ ---

        const AuthPage = ({ users, setCurrentUser, setCurrentPage, setIsManager, triggerNotify, getPublicPath }) => {
            const [phone, setPhone] = useState(''); const [name, setName] = useState(''); const [mode, setMode] = useState('login');
            const [adminPass, setAdminPass] = useState('');
            const handleAuth = async () => {
                if (mode === 'admin') {
                    if (adminPass.toLowerCase() === 'eatjoy0706') { setIsManager(true); setCurrentPage('home'); triggerNotify("ç®¡ç†å“¡æ¨¡å¼å•Ÿå‹•", "success"); }
                    else alert('é©—è­‰ç¢¼éŒ¯èª¤'); return;
                }
                if (!phone) return;
                const existing = users.find(u => u.phone === phone);
                if (mode === 'register') {
                    if (existing) return alert('æ­¤è™Ÿç¢¼å·²è¨»å†Šé');
                    await db.collection(getPublicPath('users')).doc(phone).set({ phone, name, status: 'pending' });
                    triggerNotify("ç”³è«‹å·²æäº¤ï¼Œè«‹è¯çµ¡ä¸»ç®¡", "info");
                } else {
                    if (existing) { 
                        setCurrentUser(existing); 
                        localStorage.setItem('k_active_user', JSON.stringify(existing));
                        if (existing.status === 'approved') { setCurrentPage('home'); triggerNotify(`æ­¡è¿å›ä¾†, ${existing.name}`, "success"); } 
                    }
                    else { alert('å¸³è™Ÿä¸å­˜åœ¨ï¼Œè«‹é€²è¡Œè¨»å†Š'); setMode('register'); }
                }
            };
            return (
                <div className="p-6 pt-20 text-center page-enter">
                    <div className="bg-orange-500 w-20 h-20 rounded-[1.5rem] flex items-center justify-center mx-auto mb-6 text-white shadow-xl shadow-orange-100 shadow-sm"><ChefHatIcon size={40} /></div>
                    <h2 className="text-3xl font-black text-slate-800 mb-8 tracking-tighter uppercase text-center leading-none font-bold uppercase">Kitchen OS</h2>
                    <div className="glass-panel p-8 rounded-[3rem] space-y-5 shadow-xl shadow-orange-50/5">
                        <div className="flex bg-slate-100 p-1.5 rounded-2xl border border-slate-200 shadow-inner">
                            <button onClick={() => setMode('login')} className={`flex-1 py-3 rounded-xl font-bold text-xs transition-all ${mode === 'login' ? 'bg-white shadow-sm text-orange-600' : 'text-slate-400'}`}>ç™»å…¥</button>
                            <button onClick={() => setMode('register')} className={`flex-1 py-3 rounded-xl font-bold text-xs transition-all ${mode === 'register' ? 'bg-white shadow-sm text-orange-600' : 'text-slate-400'}`}>è¨»å†Š</button>
                        </div>
                        {mode === 'register' && <input placeholder="çœŸå¯¦å§“å" className="w-full input-light p-5 rounded-2xl outline-none font-bold text-center border-0 shadow-inner font-bold" value={name} onChange={e => setName(e.target.value)} />}
                        {mode === 'admin' ? <input type="password" placeholder="ä¸»ç®¡é©—è­‰ç¢¼" className="w-full input-light p-5 rounded-2xl outline-none font-bold text-center tracking-[0.5em] border-0 shadow-inner font-bold" value={adminPass} onChange={e => setAdminPass(e.target.value)} /> : <input placeholder="æ‰‹æ©Ÿè™Ÿç¢¼" className="w-full input-light p-5 rounded-2xl outline-none font-bold tracking-widest text-center border-0 shadow-inner font-bold" value={phone} onChange={e => setPhone(e.target.value)} />}
                        <button onClick={handleAuth} className="w-full bg-orange-600 text-white font-black py-5 rounded-2xl shadow-lg uppercase text-sm shadow-orange-100 active:scale-95 transition-all font-bold uppercase">é€²å…¥ç³»çµ±</button>
                        <button onClick={() => setMode(mode === 'admin' ? 'login' : 'admin')} className="text-slate-400 font-bold text-[10px] uppercase border-b border-slate-200 pt-4 active:text-orange-500 font-bold uppercase">ä¸»ç®¡å°ˆå±¬å…¥å£</button>
                    </div>
                </div>
            );
        };

        const ListDetailPage = ({ onBack, title, list = [] }) => (
            <div className="p-4 space-y-6 page-enter pb-20 text-left font-bold">
                <BackButton onClick={onBack} title={title} />
                <div className="space-y-4">
                    {list && list.length > 0 ? list.map((item, idx) => (
                        <RuleStandardBlock key={item.id || idx} id={idx + 1} title={item.title} desc={item.content} img={item.img} />
                    )) : <div className="py-20 text-center glass-panel rounded-[3rem] border border-slate-100 bg-white shadow-inner text-slate-300 font-bold uppercase text-[10px] uppercase font-bold shadow-sm">ç›®å‰å°šæœªç™¼ä½ˆå…§å®¹</div>}
                </div>
            </div>
        );

        const UnifiedRulesPage = ({ rulesData, onBack, user, triggerNotify, getPublicPath }) => {
            const [activeTab, setActiveTab] = useState('å»šæˆ¿è¦å‰‡');
            const [signedTabs, setSignedTabs] = useState({});
            const handleSign = async (img) => {
                if (!user) return;
                try {
                    await db.collection(getPublicPath('signatures')).add({
                        userName: user.name, phone: user.phone, category: `å®ˆå‰‡ç°½ç½² - ${activeTab}`, signature: img, timestamp: Date.now()
                    });
                    setSignedTabs(prev => ({ ...prev, [activeTab]: true }));
                    triggerNotify(`[${activeTab}] ç°½åæˆåŠŸ`, "success");
                } catch (e) { triggerNotify("ç°½ç½²å¤±æ•—", "error"); }
            };
            return (
                <div className="page-enter pb-20 text-left">
                    <div className="p-4 border-b bg-white/80 backdrop-blur sticky top-[60px] z-40 shadow-sm">
                        <BackButton onClick={onBack} title="å“¡å·¥å®ˆå‰‡" />
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1 font-bold">
                            {RULE_CATEGORIES.map(cat => (
                                <button key={cat} onClick={() => setActiveTab(cat)} className={`shrink-0 px-5 py-2.5 rounded-2xl text-xs font-black border transition-all ${activeTab === cat ? 'bg-orange-500 text-white border-orange-500 shadow-md' : 'bg-white text-slate-400 border-slate-100'}`}>{cat}</button>
                            ))}
                        </div>
                    </div>
                    <div className="p-4 space-y-4">
                        <h3 className="text-[10px] font-black text-orange-600 mb-4 pl-1 uppercase tracking-widest font-bold uppercase"><Icon name="bookmark" size={14} /> ç•¶å‰åˆ†é¡ï¼š{activeTab}</h3>
                        {rulesData[activeTab] && rulesData[activeTab].length > 0 ? rulesData[activeTab].map((item, idx) => (
                            <RuleStandardBlock key={item.id || idx} id={idx + 1} title={item.title} desc={item.content} img={item.img} />
                        )) : <div className="p-20 text-center text-slate-300 font-bold text-[10px] glass-panel rounded-3xl bg-white border border-slate-100 shadow-inner font-bold uppercase">å…§å®¹è®€å–ä¸­...</div>}
                        <div className="mt-12 border-t-2 border-dashed border-slate-200 pt-10">
                            {!signedTabs[activeTab] ? <SignaturePad onSave={handleSign} /> : (
                                <div className="glass-panel p-10 rounded-[3rem] bg-emerald-50 border-emerald-100 text-emerald-600 text-center font-bold shadow-sm shadow-emerald-500/5 font-bold"><Icon name="check-circle" size={48} className="mx-auto mb-2" /> æ‚¨å·²å®Œæˆ [{activeTab}] çš„ç°½ç½²</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const InspectionPage = ({ onBack, standards, completedZones, triggerNotify, getPublicPath }) => {
            const [activeZone, setActiveZone] = useState(null);
            const [dailyPhotos, setDailyPhotos] = useState({});
            const [loading, setLoading] = useState(false);
            const [isSubmitted, setIsSubmitted] = useState(false);

            useEffect(() => {
                const unsubscribe = db.collection(getPublicPath('daily_photos_items')).onSnapshot(snapshot => {
                    const allPhotos = {}; 
                    snapshot.forEach(doc => { 
                        const data = doc.data();
                        allPhotos[`${data.zoneId}_${data.itemIdx}`] = data.photo;
                    });
                    setDailyPhotos(allPhotos);
                }, (e) => console.error("å·¡è¦–ç…§è¼‰å…¥éŒ¯èª¤", e));
                return () => unsubscribe();
            }, []);

            const handleFile = (e, idx) => {
                const file = e.target.files[0]; if (!file) return;
                const r = new FileReader();
                r.onloadend = async () => {
                    const compressed = await compressImage(r.result, 800, 0.5);
                    const zoneKey = activeZone.id;
                    db.collection(getPublicPath('daily_photos_items'))
                      .doc(`${zoneKey}_${idx}`)
                      .set({ 
                          photo: compressed, 
                          zoneId: zoneKey,
                          itemIdx: idx,
                          timestamp: Date.now() 
                      }).then(() => triggerNotify("å¯¦æ‹ç…§å·²æ›´æ–°", "success"));
                };
                r.readAsDataURL(file);
            };

            const isAllUploaded = useMemo(() => {
                if (!activeZone) return false;
                const currentStandards = standards[activeZone.id] || [];
                if (currentStandards.length === 0) return true;
                return currentStandards.every((_, i) => !!dailyPhotos[`${activeZone.id}_${i}`]);
            }, [activeZone, standards, dailyPhotos]);

            const handleSubmit = () => {
                setLoading(true);
                setTimeout(() => {
                    if (!completedZones.includes(activeZone.id)) {
                        const newCompleted = [...completedZones, activeZone.id];
                        db.doc(getPublicPath('system/progress')).update({ completedZones: newCompleted }).then(() => { 
                            if (newCompleted.length === ZONES.length) triggerLineAlert("COMPLETION"); 
                        });
                    }
                    setLoading(false);
                    setIsSubmitted(true);
                    triggerNotify("å·¡è¦–çµæœæäº¤æˆåŠŸ", "success");
                }, 800);
            };

            if(activeZone) return (
                <div className="p-4 space-y-6 page-enter pb-24 text-left font-bold">
                    <button onClick={()=>{setActiveZone(null);setIsSubmitted(false);}} className="p-3 bg-white rounded-2xl shadow-sm border active:scale-90 transition-all shadow-sm"><Icon name="arrow-left" size={20}/></button>
                    <div className="space-y-4">
                        {(standards[activeZone.id] || []).map((item, i) => (
                            <div key={i} className="glass-panel p-4 rounded-[2rem] border border-slate-100 bg-white">
                                <p className="text-[11px] font-black text-slate-700 mb-3 bg-slate-50 p-3 rounded-xl flex items-center gap-2 border shadow-inner"><Icon name="info" size={14} className="text-orange-500" />è¦æ±‚ï¼š{item.note || "ç„¡èªªæ˜"}</p>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="text-center">
                                        <span className="text-[9px] font-black text-emerald-600 uppercase font-bold">æ¨™æº–ç…§</span>
                                        <img src={item.url} className="w-full aspect-square object-cover rounded-2xl border mt-2 shadow-sm shadow-inner" />
                                    </div>
                                    <div className="text-center">
                                        <span className="text-[9px] font-black text-orange-600 uppercase font-bold">å¯¦æ‹ç…§</span>
                                        {dailyPhotos[`${activeZone.id}_${i}`] ? 
                                            <div className="relative mt-2">
                                                <img src={dailyPhotos[`${activeZone.id}_${i}`]} className="w-full aspect-square object-cover rounded-2xl border shadow-sm shadow-inner" />
                                                <label className="absolute bottom-1 right-1 bg-white/80 p-1 rounded-lg cursor-pointer border border-slate-200"><Icon name="refresh-cw" size={12}/><input type="file" className="hidden" onChange={(e)=>handleFile(e, i)} /></label>
                                            </div> : 
                                            <label className="w-full aspect-square bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center mt-2 cursor-pointer transition-all active:bg-slate-100 uppercase">
                                                <Icon name="plus" size={20} className="text-slate-300"/><span className="text-[8px] mt-1 text-slate-400">ä¸Šå‚³</span><input type="file" className="hidden" onChange={(e)=>handleFile(e, i)} />
                                            </label>
                                        }
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {!isSubmitted ? (
                        <div className="space-y-3">
                            {!isAllUploaded && (
                                <p className="text-[10px] text-red-500 font-bold text-center animate-pulse"><Icon name="alert-circle" size={12} /> è«‹å®Œæˆæ‰€æœ‰å¯¦æ‹ç…§ä¸Šå‚³å¾Œå†æäº¤</p>
                            )}
                            <button 
                                onClick={handleSubmit} 
                                disabled={!isAllUploaded || loading}
                                className={`w-full py-5 rounded-[2rem] font-black text-white shadow-xl uppercase transition-all flex items-center justify-center gap-2 
                                    ${isAllUploaded ? 'bg-orange-600 active:scale-95' : 'bg-slate-300 cursor-not-allowed'}`}
                            >
                                {loading ? "æäº¤ä¸­..." : "ç¢ºèªæäº¤å·¡è¦–çµæœ"}
                                <Icon name="check" size={18}/>
                            </button>
                        </div>
                    ) : (
                        <div className="p-8 rounded-[3rem] border-4 bg-emerald-50 border-emerald-200 text-emerald-700 animate-bounce text-center mt-4 shadow-xl shadow-emerald-500/10">
                            <h4 className="text-2xl font-black uppercase font-bold">æäº¤å®Œæˆ âœ…</h4>
                        </div>
                    )}
                </div>
            );
            return (
                <div className="p-4 space-y-4 page-enter pb-20 text-left font-bold">
                    <BackButton onClick={onBack} title="å·¡è¦–å´—ä½æ¸…å–®" />
                    <div className="bg-gradient-to-r from-orange-500 to-orange-400 p-7 rounded-[2.5rem] text-white shadow-lg flex justify-between items-center mb-6 shadow-orange-100">
                        <div><p className="text-[10px] font-black uppercase opacity-60 mb-1 leading-none tracking-widest uppercase">å·¡è¦–é€²åº¦ (20:00åˆ·æ–°)</p><p className="text-3xl font-black mt-2 font-bold uppercase">{completedZones.length} / {ZONES.length}</p></div>
                        <div className="w-14 h-14 rounded-full border-4 border-white/20 flex items-center justify-center font-bold text-xs uppercase">{Math.round((completedZones.length/ZONES.length)*100)}%</div>
                    </div>
                    <div className="grid grid-cols-1 gap-3 font-bold">
                        {ZONES.map(z => (<SectionItem key={z.id} title={z.name} iconName={completedZones.includes(z.id) ? "check-circle" : "camera"} onClick={() => setActiveZone(z)} />))}
                    </div>
                </div>
            );
        };

        const AdminPage = ({ onBack, onLogout, announcements, schedules, standards, users, triggerNotify, menu, onboarding, benefits, rulesData, getPublicPath, signatures, tickerText, setTickerText }) => {
            const [tab, setTab] = useState('members');
            const [subCat, setSubCat] = useState('list');
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedZone, setSelectedZone] = useState(ZONES[0].id);
            const [signSubCat, setSignSubCat] = useState('å»šæˆ¿è¦å‰‡');

            return (
                <div className="p-4 pb-24 page-enter text-left font-bold">
                    <div className="flex justify-between items-center mb-6">
                        <BackButton onClick={onBack} title="ç®¡ç†å¾Œå°" />
                        <button onClick={onLogout} className="bg-red-50 text-red-600 font-black text-[10px] px-4 py-2 rounded-full border border-red-100 shadow-sm active:scale-90 transition-all font-bold">ç™»å‡º</button>
                    </div>
                    <div className="flex bg-slate-100 p-1.5 rounded-2xl overflow-x-auto no-scrollbar gap-1.5 mb-6 shadow-inner font-bold">
                        {[{id:'members',n:'äººå“¡'},{id:'menu',n:'èœå–®'},{id:'content',n:'å…¬å‘Š'},{id:'onboard',n:'å…¥è·'},{id:'benefit',n:'ç¦åˆ©'},{id:'rules',n:'å®ˆå‰‡'},{id:'schedules',n:'ç­è¡¨'},{id:'safety',n:'å·¡è¦–'},{id:'sign',n:'ç°½ç½²'}].map(t => (
                            <button key={t.id} onClick={()=>{setTab(t.id); if(t.id==='rules') setSubCat('å»šæˆ¿è¦å‰‡'); else if(t.id==='sign') setSignSubCat('å»šæˆ¿è¦å‰‡'); else if(t.id==='benefit') setSubCat('eval'); else setSubCat('list');}} className={`shrink-0 px-5 py-2.5 rounded-xl text-xs font-bold transition-all ${tab===t.id?'bg-orange-600 text-white shadow-md':'text-slate-400'}`}>{t.n}</button>
                        ))}
                    </div>

                    <div className="space-y-4">
                        {tab === 'members' && users.map(u=>(<div key={u.phone} className="glass-panel p-5 rounded-[2rem] border border-slate-100 flex justify-between items-center bg-white mb-2 shadow-sm"><div><p className="font-bold text-slate-800 mb-1">{u.name}</p><p className="text-[10px] text-slate-400 font-bold">{u.phone}</p></div><div className="flex gap-2">{u.status==='pending'?<button onClick={()=>db.collection(getPublicPath('users')).doc(u.phone).update({status:'approved'})} className="bg-emerald-600 text-white px-5 py-2.5 rounded-xl text-[10px] font-black">æ ¸å‡†</button>:<span className="text-[9px] font-black text-emerald-600 border px-3 py-2 rounded-lg bg-emerald-50">å·²æˆæ¬Š</span>}<button onClick={()=>db.collection(getPublicPath('users')).doc(u.phone).delete()} className="p-2 text-slate-300 hover:text-red-500 transition-all font-bold"><Icon name="trash-2" size={16}/></button></div></div>))}
                        
                        {tab === 'content' && (
                            <div className="space-y-6">
                                <div className="glass-panel p-6 rounded-[2.5rem] bg-white border border-slate-100 shadow-sm space-y-4 shadow-sm">
                                    <h3 className="font-black text-slate-800 text-xs flex items-center gap-2 uppercase tracking-widest font-bold"><Icon name="megaphone" size={16} className="text-orange-50" />è·‘é¦¬ç‡ˆç·¨è¼¯</h3>
                                    <textarea value={tickerText} onChange={e=>setTickerText(e.target.value)} rows="2" className="w-full input-light p-4 rounded-xl text-sm font-bold outline-none shadow-inner font-bold" placeholder="å…¬å‘Šæ–‡å­—..." />
                                    <button onClick={()=>db.doc(getPublicPath('system/ticker')).set({ text: tickerText }).then(()=>triggerNotify("å…¬å‘Šå·²åŒæ­¥","success"))} className="w-full bg-slate-900 text-white font-black py-3 rounded-xl text-[10px] uppercase active:scale-95 transition-all font-bold">æ›´æ–°è·‘é¦¬ç‡ˆ</button>
                                </div>
                                <UniversalListManager docPath="system/announcements_list" items={announcements || []} titleLabel="å…¬å‘Šæ¨™é¡Œ" triggerNotify={triggerNotify} />
                            </div>
                        )}

                        {tab === 'schedules' && (
                            <div className="glass-panel p-6 rounded-[2.5rem] space-y-4 bg-white border border-slate-100 shadow-sm font-bold">
                                <h3 className="font-black text-slate-800 text-xs flex items-center gap-2 uppercase tracking-widest font-bold"><Icon name="link" size={16} className="text-blue-500" />ç­è¡¨æŸ¥çœ‹ç¶²å€</h3>
                                <input type="month" value={selectedMonth} onChange={e=>setSelectedMonth(e.target.value)} className="w-full input-light p-4 rounded-xl text-sm font-bold border-slate-200 outline-none font-bold" />
                                <div className="space-y-2">
                                    <p className="text-[10px] font-black text-slate-400 ml-1 uppercase tracking-widest font-bold">å¤–éƒ¨ç¶²å€ (Google ç¡¬ç¢Ÿ / åœ–ç‰‡é€£çµ)</p>
                                    <input placeholder="è²¼ä¸Šç¶²å€..." className="w-full input-light p-4 rounded-xl text-xs outline-none shadow-inner font-bold" onBlur={(e) => db.collection(getPublicPath('schedules_links')).doc(selectedMonth).set({ url: e.target.value }, {merge:true}).then(()=>triggerNotify("ç¶²å€å„²å­˜æˆåŠŸ","success"))} defaultValue={schedules[selectedMonth] || ''} />
                                </div>
                                <button onClick={() => { const m = selectedMonth.split('-')[1]; triggerLineAlert("SCHEDULE", { month: m }); triggerNotify(`${m}æœˆé€šçŸ¥å·²ç™¼é€è‡³ LINE`, "success"); }} className="w-full bg-slate-800 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all text-xs tracking-widest mt-2 uppercase font-bold">ğŸ“¢ æ¨é€ {selectedMonth.split('-')[1]} æœˆä»½æ›´æ–°é€šçŸ¥</button>
                            </div>
                        )}

                        {tab === 'safety' && (
                            <div className="glass-panel p-6 rounded-[2.5rem] space-y-4 bg-white border border-slate-100 shadow-sm text-left font-bold">
                                <select value={selectedZone} onChange={e=>setSelectedZone(e.target.value)} className="w-full input-light p-4 rounded-xl text-sm font-bold border-slate-200 outline-none shadow-inner font-bold">{ZONES.map(z => <option key={z.id} value={z.id}>{z.name}</option>)}</select>
                                <div className="bg-slate-50 p-4 rounded-2xl space-y-3 border border-slate-100 shadow-inner">
                                    <input id="std-note" placeholder="æª¢æŸ¥æ¨™è¨»..." className="w-full input-light p-3 rounded-xl text-xs outline-none shadow-sm shadow-inner font-bold" />
                                    <label className="bg-slate-900 text-white w-full block py-4 rounded-xl text-[10px] font-black text-center cursor-pointer uppercase shadow-lg active:scale-95 transition-all font-bold">ä¸Šå‚³æ¨™æº–ç…§<input type="file" className="hidden" onChange={e=>{const f=e.target.files[0]; if(f){const r=new FileReader(); const note=document.getElementById('std-note').value; r.onloadend=async ()=>{ const compressed = await compressImage(r.result, 800, 0.5); 
                                        db.collection(getPublicPath('standards_items')).add({
                                            zoneId: selectedZone,
                                            url: compressed,
                                            note: note,
                                            timestamp: Date.now()
                                        }).then(() => {
                                            document.getElementById('std-note').value=''; 
                                            triggerNotify("æ¨™æº–åœ–å·²åŒæ­¥","success");
                                        }); }; r.readAsDataURL(f);}}}/></label>
                                </div>
                                <div className="space-y-3 mt-4 font-bold">{(standards[selectedZone] || []).map((item, i) => (<div key={item.id} className="bg-white p-3 rounded-2xl border border-slate-100 flex gap-4 items-start shadow-sm shadow-inner"><img src={item.url} className="w-16 h-16 rounded-xl object-cover" /><div className="flex-1 text-left text-xs font-bold font-medium font-bold font-bold">{item.note || "ç„¡èªªæ˜"}</div><button onClick={()=>{db.collection(getPublicPath('standards_items')).doc(item.id).delete();}} className="p-2 text-slate-300 hover:text-red-500 transition-all font-bold font-bold"><Icon name="x" size={14}/></button></div>))}</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 4. ä¸»è¦æ‡‰ç”¨ç¨‹å¼ (Main App) ---

        const App = () => {
            const [currentPage, setCurrentPage] = useState('auth');
            const [isManager, setIsManager] = useState(false);
            const [fbReady, setFbReady] = useState(false);
            const [user, setUser] = useState(null);
            const [notifications, setNotifications] = useState([]);
            const [users, setUsers] = useState([]);
            const [currentUser, setCurrentUser] = useState(() => {
                const saved = localStorage.getItem('k_active_user');
                return saved ? JSON.parse(saved) : null;
            });
            const [announcements, setAnnouncements] = useState([]);
            const [schedules, setSchedules] = useState({});
            const [standards, setStandards] = useState({});
            const [completedZones, setCompletedZones] = useState([]);
            const [onboardingData, setOnboardingData] = useState({});
            const [benefitsData, setBenefitsData] = useState({});
            const [menuData, setMenuData] = useState({});
            const [rulesData, setRulesData] = useState({});
            const [signatures, setSignatures] = useState([]);
            const [selectedAnn, setSelectedAnn] = useState(null);
            const [tickerText, setTickerText] = useState('');
            const sentAlerts = useRef({ reminder: false, missing: false });

            const logout = () => { setCurrentUser(null); setIsManager(false); setCurrentPage('auth'); localStorage.removeItem('k_active_user'); };
            const triggerNotify = useCallback((msg, type = "info") => {
                const id = Date.now();
                setNotifications(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), 4000);
            }, []);

            useEffect(() => {
                const initAuth = async () => {
                    try { 
                        await auth.signInAnonymously(); 
                        setFbReady(true); 
                        if (currentUser) {
                            setCurrentPage('home');
                        }
                    } 
                    catch (e) { triggerNotify("Firebase é€£ç·šå¤±æ•—", "error"); }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged(u => setUser(u));
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const errHandler = (e) => { if (e.code === 'permission-denied') triggerNotify("æ¬Šé™ä¸è¶³ï¼Œè«‹è¯ç¹«ä¸»ç®¡", "error"); };

                const timerLogic = () => {
                    const now = new Date();
                    const hours = now.getHours(); const mins = now.getMinutes(); const secs = now.getSeconds();
                    const currentKey = getBusinessCycleKey();

                    if (hours === 22 && mins === 10 && secs === 0 && !sentAlerts.current.reminder) {
                        if (completedZones.length < ZONES.length) {
                            triggerLineAlert("REMINDER");
                        }
                        sentAlerts.current.reminder = true;
                    }

                    if (hours === 22 && mins === 30 && secs === 0 && !sentAlerts.current.missing) {
                        if (completedZones.length < ZONES.length) {
                            const missing = ZONES.filter(z => !completedZones.includes(z.id)).map(z => z.name);
                            triggerLineAlert("MISSING_LIST", { list: missing });
                        }
                        sentAlerts.current.missing = true;
                    }

                    if (hours === 0 && mins === 0) sentAlerts.current = { reminder: false, missing: false };

                    db.doc(getPublicPath('system/progress')).get().then(doc => {
                        const data = doc.exists ? doc.data() : {};
                        if (data.lastResetDate !== currentKey) {
                            db.doc(getPublicPath('system/progress')).set({ lastResetDate: currentKey, completedZones: [] }, { merge: true });
                            db.collection(getPublicPath('daily_photos_items')).get().then(s => s.forEach(d => d.ref.delete()));
                        }
                    });
                };
                const interval = setInterval(timerLogic, 1000);

                const subs = [
                    db.collection(getPublicPath('users')).onSnapshot(s => {
                        const allUsers = s.docs.map(d => d.data());
                        setUsers(allUsers);
                    }, errHandler),
                    db.doc(getPublicPath('system/progress')).onSnapshot(d => d.exists && setCompletedZones(d.data().completedZones || []), errHandler),
                    db.collection(getPublicPath('standards_items')).onSnapshot(snapshot => { 
                        const m = {}; 
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (!m[data.zoneId]) m[data.zoneId] = [];
                            m[data.zoneId].push({ ...data, id: doc.id });
                        });
                        Object.keys(m).forEach(k => m[k].sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0)));
                        setStandards(m); 
                    }, errHandler),
                    db.doc(getPublicPath('system/announcements_list')).onSnapshot(d => d.exists && setAnnouncements(d.data().items || []), errHandler),
                    db.doc(getPublicPath('system/ticker')).onSnapshot(d => d.exists && setTickerText(d.data().text || ''), errHandler),
                    db.collection(getPublicPath('schedules_links')).onSnapshot(snapshot => {
                        const links = {}; snapshot.forEach(doc => links[doc.id] = doc.data().url);
                        setSchedules(links);
                    }, errHandler)
                ];
                return () => { clearInterval(interval); subs.forEach(un => un()); };
            }, [user, currentUser, completedZones.length]);

            const renderPage = () => {
                switch(currentPage) {
                    case 'home': {
                        const progressPercent = Math.round((completedZones.length / ZONES.length) * 100);
                        return (
                            <div className="page-enter pb-10">
                                <Ticker text={tickerText} />
                                <div className="p-4 space-y-6 mt-2 text-left font-bold">
                                    <div onClick={() => setCurrentPage('inspection')} className="glass-panel p-6 rounded-[2.5rem] border-l-4 border-orange-500 bg-white shadow-sm active:scale-[0.98] transition-all cursor-pointer shadow-orange-500/5 shadow-sm">
                                        <div className="flex justify-between items-end mb-4 px-1">
                                            <div>
                                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 leading-none uppercase font-bold">å–„å¾Œå·¡è¦–é€²åº¦ (20:00åˆ·æ–°)</p>
                                                <h3 className="text-lg font-black text-slate-800 leading-tight font-bold uppercase">{completedZones.length === ZONES.length ? "âœ… ä»Šæ—¥å·¡è¦–å…¨æ•¸å®Œæˆ" : `é€²åº¦ï¼š${completedZones.length} / ${ZONES.length}`}</h3>
                                            </div>
                                            <span className="text-sm font-black text-orange-600 font-bold uppercase">{progressPercent}%</span>
                                        </div>
                                        <div className="bg-slate-100 h-3.5 rounded-full overflow-hidden border shadow-inner border-slate-50">
                                            <div className="h-full bg-gradient-to-r from-orange-400 to-orange-600 transition-all duration-700 ease-out shadow-[0_0_10px_rgba(249,115,22,0.3)]" style={{ width: `${progressPercent}%` }}></div>
                                        </div>
                                    </div>
                                    <section>
                                        <div className="flex items-center gap-2 mb-4 px-2 font-black text-slate-400 uppercase tracking-widest text-[10px] uppercase font-bold font-bold"><Icon name="bell" size={18} className="text-orange-500 font-bold" /><span>å…¬å‘Šæ¬„</span></div>
                                        <div className="space-y-3 font-bold">
                                            {announcements.slice(0, 3).map((ann) => (
                                                <div key={ann.id} onClick={() => { setSelectedAnn(ann); setCurrentPage('annDetail'); }} className="glass-panel p-5 rounded-[2rem] border border-slate-100 active:bg-slate-50 cursor-pointer bg-white shadow-sm shadow-orange-50/5 transition-all shadow-sm">
                                                    <h3 className="font-bold text-sm text-slate-800 mb-1 font-bold">{ann.title}</h3>
                                                    <p className="text-xs text-slate-400 line-clamp-2 leading-relaxed font-bold">{ann.content}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </section>
                                    <section className="grid grid-cols-2 gap-4 font-bold">
                                        <NavCard title="æœ¬å­£èœå–®" onClick={() => setCurrentPage('menu')} colorClass="bg-yellow-50/50" iconName="utensils" />
                                        <NavCard title="æ¯æœˆç­è¡¨" onClick={() => setCurrentPage('schedule')} colorClass="bg-indigo-50/50" iconName="calendar" />
                                    </section>
                                </div>
                            </div>
                        );
                    }
                    case 'inspection': return <InspectionPage onBack={()=>setCurrentPage('home')} standards={standards} completedZones={completedZones} triggerNotify={triggerNotify} getPublicPath={getPublicPath} />;
                    case 'admin': return <AdminPage onBack={()=>setCurrentPage('home')} onLogout={logout} announcements={announcements} schedules={schedules} standards={standards} users={users} triggerNotify={triggerNotify} getPublicPath={getPublicPath} tickerText={tickerText} setTickerText={setTickerText} />;
                    case 'annDetail': return (<div className="p-4 page-enter text-left pb-10 font-bold"><BackButton onClick={()=>setCurrentPage('home')} title="å…¬å‘Šè©³æƒ…" /><div className="glass-panel p-8 rounded-[3rem] border-l-4 border-orange-500 bg-white shadow-2xl shadow-orange-500/10 font-bold"><h1 className="text-2xl font-black mb-2 text-slate-800 leading-tight font-bold">{selectedAnn?.title}</h1><p className="text-[10px] text-slate-400 mb-8 pb-4 border-b uppercase tracking-widest font-bold uppercase">{new Date(selectedAnn?.timestamp).toLocaleDateString()}</p><div className="text-sm text-black leading-relaxed font-bold">{selectedAnn?.content}</div></div><button onClick={()=>setCurrentPage('home')} className="w-full py-5 bg-slate-900 text-white font-black rounded-2xl uppercase tracking-widest shadow-xl mt-4 active:scale-95 transition-all font-bold">è¿”å›é¦–é </button></div>);
                    default: return <div className="p-20 text-center text-slate-400 font-black h-screen flex flex-col items-center justify-center gap-4 font-bold uppercase tracking-widest"><Icon name="loader-2" className="animate-spin text-orange-500" size={32}/> ç³»çµ±å•Ÿå‹•ä¸­...</div>;
                }
            };

            return (
                <div className="min-h-screen flex flex-col bg-[#fff5f5]">
                    <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[1000] w-full max-w-xs space-y-3 pointer-events-none px-4 text-left font-bold">
                        {notifications.map(n => (
                            <div key={n.id} className={`toast-enter p-5 rounded-[2rem] shadow-2xl flex items-center gap-4 glass-panel border-l-4 ${n.type === 'success' ? 'border-l-emerald-500 text-emerald-700' : 'border-l-orange-500 text-orange-700'} shadow-sm`}>
                                <Icon name={n.type === 'success' ? 'check-circle' : 'alert-triangle'} size={24} /><span className="font-bold text-xs leading-tight">{n.msg}</span>
                            </div>
                        ))}
                    </div>

                    <header className="p-5 sticky top-0 z-50 flex justify-between items-center bg-white/80 backdrop-blur-md border-b border-slate-100 shadow-sm font-bold">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => (isManager || currentUser?.status === 'approved') && setCurrentPage('home')}>
                            <div className="bg-orange-600 p-2 rounded-xl text-white shadow-lg shadow-orange-100 shadow-sm"><ChefHatIcon size={20}/></div>
                            <span className="font-black text-xl text-slate-800 uppercase leading-none tracking-tighter font-bold uppercase">Kitchen OS</span>
                        </div>
                        <div className="flex gap-4 font-bold">
                            <button onClick={() => isManager ? setCurrentPage('admin') : (currentUser?.status === 'approved' && setCurrentPage('home'))} className="text-slate-400 active:scale-90 hover:text-slate-600 transition-all"><Icon name={isManager ? "settings" : "bell"} size={22} /></button>
                            {(currentUser || isManager) && <button onClick={logout} className="p-1 text-slate-300 active:scale-90 hover:text-red-500 transition-all"><Icon name="log-out" size={20} /></button>}
                        </div>
                    </header>

                    <main className="flex-grow max-w-lg mx-auto w-full font-bold">
                        {!fbReady ? (
                            <div className="p-20 text-center flex flex-col items-center gap-4 h-screen justify-center font-bold"><Icon name="loader-2" className="animate-spin text-orange-500" size={48}/><p className="text-slate-400 font-black text-xs uppercase tracking-widest">åŒæ­¥é›²ç«¯é€£ç·šä¸­...</p></div>
                        ) : (!isManager && !currentUser) ? (
                            <AuthPage users={users} setCurrentUser={setCurrentUser} setCurrentPage={setCurrentPage} setIsManager={setIsManager} triggerNotify={triggerNotify} getPublicPath={getPublicPath} />
                        ) : (isManager || currentUser?.status === 'approved') ? renderPage() : (
                            <div className="p-10 pt-32 text-center h-screen space-y-8 page-enter font-bold">
                                <div className="bg-white w-24 h-24 rounded-full flex items-center justify-center mx-auto shadow-lg shadow-orange-100 shadow-sm"><Icon name="clock" size={48} className="text-orange-500 animate-pulse" /></div>
                                <div className="space-y-2 text-center px-4 font-bold"><h3 className="text-2xl font-black text-slate-800 tracking-tighter uppercase font-bold">æˆæ¬Šç­‰å¾…ä¸­</h3><p className="text-slate-500 text-sm font-bold leading-relaxed px-10 font-bold">è¨»å†Šç”³è«‹å·²æäº¤ã€‚è«‹è¯ç¹«ç¾å ´ä¸»ç®¡æ ¸å‡†æˆæ¬Šä»¥é€²å…¥ç³»çµ±ã€‚</p></div>
                                <button onClick={logout} className="text-slate-400 font-bold border-b border-slate-200 pb-1 text-sm uppercase font-bold tracking-widest active:text-orange-500 transition-all uppercase">ç™»å‡ºä¸¦è¿”å›</button>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
